# API Demo — Визуализация запросов в прототипах

> **Статус**: Предложение / Анализ  
> **Дата**: 2026-02-24  
> **Автор**: Copilot + системный аналитик

---

## 1. Суть идеи

При выполнении действий в прототипе (нажатие кнопок, сохранение, удаление, загрузка данных) — **показывать пользователю имитацию реальных API-запросов**: метод, URL, тело запроса, ответ сервера, статус-код, время выполнения.

**Цель**: дать заказчику и разработчикам понимание, **какие серверные вызовы стоят за каждым действием** в интерфейсе, без необходимости открывать DevTools.

---

## 2. Анализ текущей архитектуры

### Что уже есть

| Элемент | Состояние | Как используется |
|---------|----------|-----------------|
| **Имитация задержки** | ✅ Есть | `setTimeout(…, 1500)` в экранах pudu-admin |
| **Toast-уведомления** | ⚠️ Локально | Каждый прототип реализует свой toast (pudu-admin — в корневом компоненте) |
| **UiModalComponent** | ✅ Есть | Размеры `sm`/`md`/`lg`/`xl`/`full`, используется повсеместно |
| **UiBadgeComponent** | ✅ Есть | Варианты `default`/`success`/`danger`/`warning` — подойдёт для статусов |
| **Анимации CSS** | ✅ Есть | `animate-fade-in`, `animate-slide-up`, `animate-slide-in-right`, `animate-scale-in` |
| **StorageService** | ✅ Есть | Централизованное хранение данных в localStorage |
| **Централизованный Toast-сервис** | ❌ Нет | Нужно создавать |
| **API Demo Service** | ❌ Нет | Нужно создавать |

### Вывод

Инфраструктура проекта **позволяет реализовать** API-визуализацию с минимальными изменениями в архитектуре. Основные UI-компоненты (`UiModal`, `UiBadge`, `UiTable`) уже существуют. Не хватает только **централизованного сервиса** и **компонентов отображения**.

---

## 3. Варианты реализации (5 подходов)

### Вариант A: Выдвижная нижняя панель (Bottom Drawer)

```
┌─────────────────────────────────────────────┐
│  sidebar  │  top-bar                        │
│           │  ┌────────────────────────────┐  │
│           │  │    Основной контент        │  │
│           │  │    прототипа               │  │
│           │  │                            │  │
│           │  ├────────── drag ────────────┤  │
│           │  │ ▼ POST /api/orders  200 OK │  │
│           │  │ ▼ GET  /api/robots  200 OK │  │
│           │  └────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

| Критерий | Оценка |
|----------|--------|
| Сложность | 🟡 Средняя (resizable handle, пересчёт layout) |
| Объём информации | 🟢 Высокий |
| Не мешает UI | 🟡 Сжимает контент по высоте |
| Для заказчиков | 🟡 Слишком «технический» вид |

**Плюсы**: привычная метафора DevTools, видна история запросов, детали раскрываются.  
**Минусы**: ломает layout прототипов с длинными таблицами/формами, сложный resize.

---

### Вариант B: Боковая панель справа (Side Panel)

```
┌─────────────────────────────────────────────────────┐
│  sidebar  │  top-bar                   │  API Panel  │
│           │  ┌────────────────────┐    │ ┌─────────┐ │
│           │  │ Основной контент   │    │ │POST /api│ │
│           │  │ прототипа          │    │ │ 200 OK  │ │
│           │  │                    │    │ │ 230ms   │ │
│           │  │                    │    │ │─────────│ │
│           │  │                    │    │ │GET /api │ │
│           │  └────────────────────┘    │ │ 200 OK  │ │
│           │                            │ └─────────┘ │
└─────────────────────────────────────────────────────┘
```

| Критерий | Оценка |
|----------|--------|
| Сложность | 🟡 Средняя |
| Объём информации | 🟢 Высокий |
| Не мешает UI | 🟡 Сжимает контент по ширине |
| Для заказчиков | 🟢 Можно показать API и UI рядом |

**Плюсы**: API и интерфейс видны одновременно, естественный лог сверху вниз.  
**Минусы**: сжимает контент (уже есть sidebar слева), на узких экранах тесно.

---

### Вариант C: Toast-уведомления (мини-карточки)

```
┌─────────────────────────────────────────────┐
│  sidebar  │  top-bar                        │
│           │  ┌────────────────────────────┐  │
│           │  │                            │  │
│           │  │    Основной контент        │  │
│           │  │    прототипа               │  │
│           │  │                            │  │
│           │  │          ┌───────────────┐ │  │
│           │  │          │ POST /orders  │ │  │
│           │  │          │ → 200 OK 230ms│ │  │
│           │  └──────────└───────────────┘─┘  │
└─────────────────────────────────────────────┘
```

| Критерий | Оценка |
|----------|--------|
| Сложность | 🟢 Низкая |
| Объём информации | 🔴 Низкий (только метод + URL + статус) |
| Не мешает UI | 🟢 Вообще не влияет на layout |
| Для заказчиков | 🟢 Интуитивно, ненавязчиво |

**Плюсы**: простейшая реализация, мгновенная обратная связь, не требует действий.  
**Минусы**: нет тела запроса/ответа, нет истории (исчезают через 3 сек).

---

### Вариант D: Модальное окно с логом (по кнопке)

```
┌─────────────────────────────────────────────┐
│        ┌─── API Log Modal ───────────┐      │
│        │                              │      │
│        │  POST /api/orders    200 OK  │      │
│        │  ▶ Развернуть детали         │      │
│        │  ┌──────────────────────────┐│      │
│        │  │ Request:  { name: "..." }││      │
│        │  │ Response: { id: 42 }     ││      │
│        │  │ Время: 230ms             ││      │
│        │  └──────────────────────────┘│      │
│        │                              │      │
│        │  GET /api/robots     200 OK  │      │
│        │  ▶ Развернуть детали         │      │
│        │                              │      │
│        │              [ Очистить лог ]│      │
│        └──────────────────────────────┘      │
└─────────────────────────────────────────────┘
```

| Критерий | Оценка |
|----------|--------|
| Сложность | 🟢 Низкая (переиспользуем UiModal) |
| Объём информации | 🟢 Максимальный (JSON request/response) |
| Не мешает UI | 🟢 Скрыта, пока не откроешь |
| Для заказчиков | 🟢 Можно показать в нужный момент |

**Плюсы**: полная информация, JSON тела, аккордеон-детали, переиспользуем `UiModalComponent`.  
**Минусы**: нельзя видеть UI и API одновременно, нужно помнить нажать кнопку.

---

### Вариант E: Анимированная схема потока данных

```
┌─────────────────────────────────────────────┐
│           ┌────────┐  ───▶  ┌────────┐      │
│           │ Client │  POST  │ Server │      │
│           │  (UI)  │  ◀───  │  API   │      │
│           └────────┘  200OK └────────┘      │
│               ↑                  ↓          │
│           animate!          ┌────────┐      │
│                             │   DB   │      │
│                             └────────┘      │
└─────────────────────────────────────────────┘
```

| Критерий | Оценка |
|----------|--------|
| Сложность | 🔴 Высокая (SVG-анимации, координация) |
| Объём информации | 🔴 Низкий |
| Не мешает UI | 🔴 Занимает весь экран |
| Для заказчиков | 🟢 Wow-эффект |

**Плюсы**: максимально наглядно, эффектно для презентаций.  
**Минусы**: огромная сложность, плохо масштабируется, тяжело поддерживать, нельзя показать JSON.

---

## 4. Сравнительная таблица

| Подход | Сложность | Инфо | Layout | Заказчики | Рекомендация |
|--------|-----------|------|--------|-----------|-------------|
| A. Bottom Drawer | 🟡 Средняя | 🟢 | 🟡 | 🟡 | Запасной |
| B. Side Panel | 🟡 Средняя | 🟢 | 🟡 | 🟢 | Альтернатива |
| C. Toast | 🟢 Низкая | 🔴 | 🟢 | 🟢 | **Дополнение** |
| D. Modal Log | 🟢 Низкая | 🟢 | 🟢 | 🟢 | **Основной** |
| E. Animated Flow | 🔴 Высокая | 🔴 | 🔴 | 🟢 | Не стоит |

---

## 5. ⭐ Рекомендация: Гибридный подход C + D

### Toast (пассивная обратная связь) + Modal Log (детали по запросу)

Это **оптимальный баланс** между информативностью, простотой и удобством для заказчиков.

### Как это работает на практике

#### Шаг 1 — Пользователь нажимает «Сохранить ресторан»

```
Toast всплывает в правом нижнем углу:
┌─────────────────────────────────┐
│ ● POST /api/v1/restaurants/42   │
│   ⏳ Отправка...                │
└─────────────────────────────────┘
         ↓ через 300ms
┌─────────────────────────────────┐
│ ✓ POST /api/v1/restaurants/42   │
│   200 OK • 230ms               │
└─────────────────────────────────┘
         ↓ через 3 сек — исчезает
```

#### Шаг 2 — Аналитик хочет показать детали

Нажимает кнопку `</>` в top-bar → открывается модалка:

```
┌─────────── API Запросы (3) ──────────────────┐
│                                               │
│  ▼ POST /api/v1/restaurants/42     200 OK     │
│  ┌───────────────────────────────────────┐    │
│  │ Описание: Обновление данных ресторана │    │
│  │ Время: 14:32:05 • 230ms              │    │
│  │                                       │    │
│  │ Request Body:                         │    │
│  │ ┌─────────────────────────────────┐   │    │
│  │ │ {                               │   │    │
│  │ │   "name": "Пицца Хаус",        │   │    │
│  │ │   "address": "ул. Ленина, 42", │   │    │
│  │ │   "status": "active"           │   │    │
│  │ │ }                               │   │    │
│  │ └─────────────────────────────────┘   │    │
│  │                                       │    │
│  │ Response Body:                        │    │
│  │ ┌─────────────────────────────────┐   │    │
│  │ │ {                               │   │    │
│  │ │   "success": true,             │   │    │
│  │ │   "id": 42                     │   │    │
│  │ │ }                               │   │    │
│  │ └─────────────────────────────────┘   │    │
│  └───────────────────────────────────────┘    │
│                                               │
│  ▶ GET /api/v1/restaurants          200 OK    │
│  ▶ GET /api/v1/robots               200 OK    │
│                                               │
│  [ Очистить лог ]              [ Закрыть ]    │
└───────────────────────────────────────────────┘
```

---

## 6. Архитектура реализации

### 6.1. Новые файлы

```
src/app/shared/
├── api-demo.types.ts              ← Типы (ApiDemoRequest, ApiDemoConfig)
├── api-demo.service.ts            ← Сервис имитации и хранения запросов

src/app/components/layout/
├── api-demo-toast.component.ts    ← Toast-уведомления о запросах
├── api-demo-button.component.ts   ← Кнопка </> в top-bar
└── api-demo-modal.component.ts    ← Модалка с историей запросов
```

### 6.2. Типы данных

```typescript
// src/app/shared/api-demo.types.ts

export interface ApiDemoRequest {
  id: string;                                        // Уникальный ID
  method: 'GET' | 'POST' | 'PUT' | 'PATCH' | 'DELETE';
  url: string;                                       // '/api/v1/restaurants/42'
  requestBody?: any;                                 // JSON тело запроса
  responseBody?: any;                                // JSON ответ
  status: number;                                    // 200, 201, 400, 404, 500
  statusText: string;                                // 'OK', 'Created', 'Not Found'
  timestamp: Date;                                   // Когда отправлен
  duration: number;                                  // Длительность (мс)
  description: string;                               // 'Обновление данных ресторана'
  state: 'pending' | 'success' | 'error';            // Текущее состояние
}

export interface ApiDemoConfig {
  method: ApiDemoRequest['method'];
  url: string;
  requestBody?: any;
  responseBody?: any;
  status?: number;                                   // default: 200
  statusText?: string;                               // default: 'OK'
  description: string;
  delay?: number;                                    // default: random 200-800ms
}
```

### 6.3. Сервис ApiDemoService

```typescript
// src/app/shared/api-demo.service.ts

@Injectable({ providedIn: 'root' })
export class ApiDemoService {
  
  // Реактивный поток — подписка для toast-компонента
  private requestSubject = new Subject<ApiDemoRequest>();
  request$ = this.requestSubject.asObservable();

  // История запросов — для модалки
  private history: ApiDemoRequest[] = [];

  // Глобальный переключатель (вкл/выкл визуализацию)
  enabled = true;

  /**
   * Имитирует API-запрос с задержкой.
   * 
   * Пример использования:
   *   await this.api.simulate({
   *     method: 'POST',
   *     url: '/api/v1/restaurants/42',
   *     requestBody: { name: 'Пицца Хаус' },
   *     responseBody: { success: true, id: 42 },
   *     description: 'Обновление данных ресторана',
   *   });
   */
  async simulate(config: ApiDemoConfig): Promise<ApiDemoRequest> {
    const id = this.generateId();
    const delay = config.delay ?? this.randomDelay(200, 800);

    // 1. Эмитим «pending» → toast показывает спиннер
    const pending: ApiDemoRequest = {
      id, method: config.method, url: config.url,
      requestBody: config.requestBody,
      responseBody: null,
      status: 0, statusText: 'Pending...',
      timestamp: new Date(), duration: 0,
      description: config.description,
      state: 'pending',
    };
    
    if (this.enabled) this.requestSubject.next(pending);

    // 2. Имитация задержки сети
    await new Promise(resolve => setTimeout(resolve, delay));

    // 3. Эмитим «completed» → toast обновляется
    const completed: ApiDemoRequest = {
      ...pending,
      responseBody: config.responseBody ?? { success: true },
      status: config.status ?? 200,
      statusText: config.statusText ?? 'OK',
      duration: delay,
      state: (config.status ?? 200) >= 400 ? 'error' : 'success',
    };

    this.history.unshift(completed);
    if (this.enabled) this.requestSubject.next(completed);

    return completed;
  }

  getHistory(): ApiDemoRequest[] { return this.history; }
  clearHistory(): void { this.history = []; }
}
```

### 6.4. Интеграция в top-bar

В `top-bar.component.ts` добавляется кнопка `</>` (рядом с changelog и reset):

```
┌───────────────────────────────────────────────────────────────┐
│  Название прототипа — Описание    [Reset] [</>] [v1.2] [Прототип] │
└───────────────────────────────────────────────────────────────┘
```

Кнопка `</>`:
- Показывает красный бейдж с количеством запросов (если > 0)
- По клику открывает `ApiDemoModalComponent`
- Отображается **только** если прототип подключил `ApiDemoService`

### 6.5. Использование в экранах прототипов

**До** (текущий код):
```typescript
// pudu-admin: подключение к NE
this.credSaving = true;
setTimeout(() => {
  this.setNeConnectionStatus('connected');
  this.parent.showToast('Подключение к NE настроено');
  this.credSaving = false;
}, 1500);
```

**После** (с API Demo):
```typescript
// pudu-admin: подключение к NE
this.credSaving = true;
await this.api.simulate({
  method: 'POST',
  url: '/api/v1/pudu/credentials',
  requestBody: {
    server: this.neServer,
    appId: this.neAppId,
    secretKey: '***',
  },
  responseBody: { connected: true, robots: 3 },
  description: 'Подключение к серверу Pudu',
  delay: 1500,
});
this.setNeConnectionStatus('connected');
this.parent.showToast('Подключение к NE настроено');
this.credSaving = false;
```

**Ключевое**: `simulate()` заменяет `setTimeout()` — задержка сохраняется, но теперь она визуализируется.

---

## 7. Визуальный дизайн Toast-карточки

### Состояние «pending» (загрузка)

```
┌─────────────────────────────────────────┐
│  ⟳  POST /api/v1/pudu/credentials      │
│     Подключение к серверу Pudu          │
│     ⏳ Отправка...                      │
└─────────────────────────────────────────┘
```

- Фон: `bg-blue-50`, бордюр: `border-l-4 border-blue-500`
- Иконка: вращающийся спиннер
- Автоматически обновится при получении ответа

### Состояние «success»

```
┌─────────────────────────────────────────┐
│  ✓  POST /api/v1/pudu/credentials      │
│     Подключение к серверу Pudu          │
│     200 OK • 1.5s                       │
└─────────────────────────────────────────┘
```

- Фон: `bg-green-50`, бордюр: `border-l-4 border-green-500`
- Иконка: зелёная галочка
- Исчезает через 4 секунды

### Состояние «error»

```
┌─────────────────────────────────────────┐
│  ✗  POST /api/v1/pudu/credentials      │
│     Подключение к серверу Pudu          │
│     500 Internal Server Error • 2.1s    │
└─────────────────────────────────────────┘
```

- Фон: `bg-red-50`, бордюр: `border-l-4 border-red-500`
- Иконка: красный крестик
- Исчезает через 6 секунд (дольше, чтобы заметили)

### Цветовое кодирование метода

| Метод | Цвет бейджа |
|-------|------------|
| GET | `bg-blue-100 text-blue-700` |
| POST | `bg-green-100 text-green-700` |
| PUT | `bg-amber-100 text-amber-700` |
| PATCH | `bg-orange-100 text-orange-700` |
| DELETE | `bg-red-100 text-red-700` |

---

## 8. Фичи модального окна

### Основные
- **Список запросов** — от новых к старым, с аккордеон-раскрытием деталей
- **JSON Viewer** — подсветка синтаксиса (моноширинный шрифт, `<pre>` блок)
- **Фильтр по методу** — кнопки GET / POST / PUT / DELETE для фильтрации
- **Поиск** — по URL или описанию
- **Очистка лога** — кнопка «Очистить»

### Бонусные (можно добавить позже)
- **Копирование curl** — кнопка «Copy as cURL» для каждого запроса
- **Экспорт** — скачать лог как JSON-файл
- **Timeline** — визуальная шкала времени (waterfall, как в DevTools)
- **Вкл/Выкл** — toggle в модалке для глобального включения/выключения визуализации

---

## 9. Подключение к прототипу (opt-in)

API Demo — **opt-in система**. Прототипы, которые не используют `ApiDemoService`, не показывают ни toast, ни кнопку `</>`.

### Шаг 1: Флаг в реестре прототипов

```typescript
// prototypes.registry.ts
export interface PrototypeEntry {
  path: string;
  label: string;
  icon: string;
  description: string;
  apiDemo?: boolean;    // ← новое поле
}

export const PROTOTYPES: PrototypeEntry[] = [
  {
    path: '/prototype/pudu-admin',
    label: 'Pudu Admin',
    icon: 'settings',
    description: '...',
    apiDemo: true,       // ← включено
  },
];
```

### Шаг 2: top-bar проверяет флаг

```typescript
// top-bar.component.ts
showApiDemo = this.currentPrototype?.apiDemo ?? false;
```

### Шаг 3: Экраны вызывают simulate()

```typescript
private api = inject(ApiDemoService);

async onSave() {
  await this.api.simulate({
    method: 'PUT',
    url: `/api/v1/restaurants/${this.id}`,
    requestBody: this.formData,
    responseBody: { success: true },
    description: 'Сохранение настроек ресторана',
  });
  // ... обычная логика сохранения
}
```

---

## 10. План реализации

### Этап 1 — Ядро (1-2 часа)
1. Создать `api-demo.types.ts` и `api-demo.service.ts`
2. Создать `api-demo-toast.component.ts`
3. Интегрировать toast в `main-layout.component.ts`
4. Тест на одном экране pudu-admin

### Этап 2 — Модалка (1-2 часа)
5. Создать `api-demo-modal.component.ts`
6. Создать `api-demo-button.component.ts` в top-bar
7. Добавить `apiDemo` поле в `prototypes.registry.ts`

### Этап 3 — Интеграция в прототип (2-3 часа на прототип)
8. Заменить `setTimeout()` на `api.simulate()` в экранах
9. Добавить осмысленные URL, тела запросов и ответов
10. Покрыть все действия: CRUD, загрузка данных, etc.

### Общая оценка
- **Ядро + Модалка**: ~3-4 часа
- **Интеграция одного прототипа**: ~2-3 часа
- **Итого MVP**: ~5-7 часов

---

## 11. Альтернативный вариант: Bottom Drawer (если Toast+Modal не устроит)

Если окажется, что нужно **одновременно** видеть UI и лог запросов:

```
┌─────────────────────────────────────────────┐
│  sidebar  │  top-bar                        │
│           │  ┌────────────────────────────┐  │
│           │  │    Основной контент        │  │
│           │  │    (высота уменьшается)    │  │
│           │  ├═══════ drag handle ════════┤  │
│           │  │ Method   URL        Status │  │
│           │  │ POST     /api/rest  200 OK │  │
│           │  │ GET      /api/rob   200 OK │  │
│           │  └────────────────────────────┘  │
└─────────────────────────────────────────────┘
```

Это потребует:
- Drag-handle для resize
- Пересчёт высоты контента
- Сложность выше на ~40%

**Рекомендация**: начать с Toast + Modal, а если появится запрос «хочу видеть одновременно» — добавить Bottom Drawer как опцию.

---

## 12. Ответ на ключевой вопрос: «Можно ли реализовать?»

### ✅ Да, однозначно можно

| Аспект | Ответ |
|--------|-------|
| Технически возможно? | ✅ Полностью, Angular 16 + Tailwind поддерживают всё необходимое |
| UI-компоненты готовы? | ✅ UiModal, UiBadge, анимации — уже есть |
| Сложно ли? | 🟢 Низкая-средняя сложность (ядро — 3-4 часа) |
| Будет ли мешать? | 🟢 Нет — opt-in система, включается per-prototype |
| Нужно ли менять существующий код? | 🟡 Минимально — замена setTimeout на simulate() |
| Ценность для заказчиков? | 🟢 Высокая — наглядно показывает «что происходит под капотом» |

### Главная ценность

Заказчик видит не просто «кнопка нажалась → данные появились», а понимает:
- **Какой API-эндпоинт** вызывается
- **Какие данные уходят** на сервер
- **Что сервер отвечает**
- **Сколько времени** это занимает

Это критически полезно при согласовании API-контрактов между фронтом и бэкендом.
