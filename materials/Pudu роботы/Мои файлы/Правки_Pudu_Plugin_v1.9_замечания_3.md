# Правки Pudu Plugin v1.9 — По замечаниям №3

> Дата: 2026-02-18
> Прототип: `front-pudu-plugin`
> Версия: 1.8 → 1.9

---

## Общая суть изменений

Добавлена полная поддержка пути **«Дополнения → Плагины»** в контексте **«Из заказа»**, по аналогии с главным экраном. Все команды (кроме «Повторить отправку») теперь проходят через экран выбора робота. Переделано окно «Повторить доставку» — добавлена информация о роботе. Исправлены баги.

---

## 1. Кнопка «Дополнения → Плагины» в экране «Из заказа»

**Файл**: `pudu-pos-screen.component.ts` (шаблон)

- В панели кнопок контекста «Из заказа» добавлена кнопка **«Дополнения → Плагины»** — полноширинная кнопка над 4 кнопками действий
- По аналогии с главным экраном: при нажатии открывается окно **«Плагины»**

---

## 2. Окно «Плагины» из контекста заказа

**Файл**: `pudu-pos-screen.component.ts` (шаблон + логика)

- Новое модальное окно `plugins_menu_order` — сетка кнопок 3×6 (стиль Front)
- Содержит одну активную кнопку: **«Pudu: Команды»**
- Остальные ячейки — плейсхолдеры (17 штук)
- Метод `openPluginsMenuOrder()` открывает это окно

---

## 3. Окно «Команды роботам» из контекста заказа

**Файл**: `pudu-pos-screen.component.ts` (шаблон + логика)

- Новое модальное окно `pudu_commands_order` с заголовком **«Команды роботам»**
- Кнопка возврата «←» ведёт обратно к окну «Плагины (из заказа)»
- **4 кнопки** в сетке 2×2:
  - **Отправить меню** → выбор робота → модалка «Отправить меню»
  - **Уборка посуды** → выбор робота → модалка «Уборка посуды»
  - **Доставка блюд** → выбор робота → модалка «Доставка блюд»
  - **Повторить отправку** → напрямую окно «Повторить доставку» (без выбора робота)
- Кнопка «Повторить отправку» неактивна, пока нет завершённой доставки (`sendDishCompleted`)

---

## 4. Выбор робота перед действиями из заказа

**Файл**: `pudu-pos-screen.component.ts` (логика)

- Добавлена переменная `pendingOrderCommand: 'send_menu' | 'cleanup' | 'send_dish' | null`
- При нажатии на Отправить меню / Уборка / Доставка из «Команды роботам» → сохраняется `pendingOrderCommand`, открывается окно выбора робота (`robot_select`)
- Метод `confirmRobotSelection()` расширен:
  - Если есть `pendingOrderCommand` — сохраняет данные робота (`lastDeliveryRobotName`, `lastDeliveryRobotId`, `lastDeliveryRobotStatus`) и открывает соответствующую модалку
  - Если нет — работает как раньше (маркетинг)
- `closeDialog()` сбрасывает `pendingOrderCommand`

---

## 5. Переделка окна «Повторить доставку»

**Файл**: `send-dish-repeat.component.ts`

- Добавлены новые `@Input()` свойства:
  - `robotName: string` — отображаемое имя робота
  - `robotId: string` — ID робота
  - `robotStatus: 'free' | 'busy' | 'offline'` — текущий статус
- В шаблон добавлен блок **«Робот из предыдущей доставки»**:
  - Имя робота
  - ID робота (моноширинный шрифт)
  - Статус с цветовым индикатором (зелёный/оранжевый/серый)
- Если робот в статусе `busy` — показывается предупреждение: «Робот сейчас занят. Команда будет отправлена и выполнена после завершения текущей задачи»

---

## 6. Исправлен баг: окно «Повторить доставку» закрывается автоматически

**Файл**: `pudu-pos-screen.component.ts` (scenarioChains)

- Сценарий `send-dish-repeat`: delay увеличен с 3000 мс до 60000 мс
- Теперь окно не закрывается автоматически — только при ручном действии пользователя (кнопка «Отмена» или «Повторить»)

---

## 7. Новые типы модальных окон

**Файл**: `types.ts`

- Добавлены типы в `PuduModalType`:
  - `'plugins_menu_order'` — окно «Плагины» из контекста заказа
  - `'pudu_commands_order'` — окно «Команды роботам» из контекста заказа

---

## 8. Новые ячейки каталога

**Файл**: `catalog-entries.ts`

- Добавлены 2 ячейки в секцию «Контекст — Из заказа»:
  - **«Дополнения → Плагины»** — открывает `plugins_menu_order` в контексте заказа
  - **«Команды роботам (из заказа)»** — открывает `pudu_commands_order` в контексте заказа
- Обе ячейки имеют бейдж `v1.9`

---

## 9. Новые переменные состояния

**Файл**: `pudu-pos-screen.component.ts`

- `pluginPlaceholdersOrder` — массив из 17 элементов для плейсхолдеров сетки плагинов из заказа
- `lastDeliveryRobotName` — имя робота последней доставки (для «Повторить»)
- `lastDeliveryRobotId` — ID робота последней доставки
- `lastDeliveryRobotStatus` — статус робота последней доставки
- `pendingOrderCommand` — отложенная команда после выбора робота

---

## Затронутые файлы

| Файл | Тип изменения |
|------|--------------|
| `types.ts` | Добавлены 2 новых типа модалок |
| `pudu-pos-screen.component.ts` | Шаблон + логика: кнопка «Дополнения», окна «Плагины» и «Команды», выбор робота, переменные |
| `send-dish-repeat.component.ts` | Добавлены @Input для робота, шаблон расширен блоком робота |
| `catalog-entries.ts` | 2 новые ячейки каталога |
| `changelog.data.ts` | Добавлена секция v1.9 |
