# Промт-патч v1.1: Плагин iikoFront — Управление роботами PUDU (POS-терминал)

---
**Версия**: 1.1
**Дата**: 2026-02-13
**Автор**: Кирилл Тюрин (системный аналитик)
**Статус**: [PENDING]
**Артефакт**: Д4-патч (Промт-патч для обновления прототипа POS-плагина iikoFront)
**Базовый документ**: Промт_прототипа_PUDU_плагин_iikoFront.md (v1.0, 2026-02-11)
**Источники**: Встреча с NE 11.02.2026; Документ «IIKO web.docx» от NE; Документ «статус сценария.docx» от NE; План обновления (2026-02-13)
**Замечания**: З-12, З-15, З-33, З-34, З-35, З-36, З-37, З-39, З-40, З-42, З-43
---

## Назначение

Этот документ — **дельта-патч** к промту v1.0. Он описывает **только изменения**, которые необходимо внести в прототип плагина iikoFront по результатам встречи с NE (11.02.2026) и документов от заказчика.

**Инструкция по применению**: открой базовый промт `Промт_прототипа_PUDU_плагин_iikoFront.md` (v1.0) и примени все изменения ниже последовательно. Каждый раздел указывает, что **удалить**, что **добавить** и что **изменить**.

---

## D1. Два контекста вызова плагина: архитектурное изменение

> **Замечания**: З-33, З-35, З-37
> **Источник**: Кирилл (43:03): «Кнопка маркетинг принудительный появится на экране... не работает с заказом. Она в общем экране»; Кирилл (~40:57): «Выбираем стол... нажимаем Дополнение... PUDU: Отправить меню, Уборка, Доставка блюд»; Олег (39:48): «Уборка посуды может включать прям несколько столиков. Там официант кликнет условно уборка столов и там кликнет стол 1, 2, 3 и робот поедет по ним»

### КЛЮЧЕВОЕ АРХИТЕКТУРНОЕ ИЗМЕНЕНИЕ

В v1.0 прототип имел **один контекст** вызова плагина — из экрана заказа. Теперь необходимо разделить на **два контекста** с разным набором доступных действий.

> **[PENDING NE CONFIRMATION — НВ-15]**: На главном экране помимо маркетинга добавлена уборка (мультивыбор столов). Это необходимо для реализации З-35 (мультивыбор столов для уборки), т.к. из контекста заказа стол уже известен (один). Требует подтверждения Руслана / NE.

### Контекст 1: «Главный экран → Дополнения → PUDU»

**Условие**: Оператор находится на главном экране iikoFront (не в заказе). Нет контекста стола.

**Доступные действия**:

| #   | Кнопка                | Иконка Lucide | Действие                                                               | Примечание                   |
| --- | --------------------- | ------------- | ---------------------------------------------------------------------- | ---------------------------- |
| 1   | Маркетинг             | `radio`       | Toggle `isCruiseActive` — запуск/остановка принудительного круиза      | Активна                      |
| 2   | Уборка (выбор столов) | `trash-2`     | `activeModal = 'cleanup_multi_select'` — мультивыбор столов для уборки | Активна. **[PENDING НВ-15]** |

### Контекст 2: «Из заказа → Дополнения → PUDU»

**Условие**: Оператор находится в экране заказа. Известен стол из контекста.

**Доступные действия**:

| #   | Кнопка         | Иконка Lucide | Действие                            | Примечание                               |
| --- | -------------- | ------------- | ----------------------------------- | ---------------------------------------- |
| 1   | Отправить меню | `utensils`    | `activeModal = 'send_menu_confirm'` | Стол из контекста заказа                 |
| 2   | Уборка посуды  | `trash-2`     | `activeModal = 'cleanup_confirm'`   | Стол из контекста (один стол)            |
| 3   | Доставка блюд  | `package`     | `activeModal = 'send_dish_blocked'` | [BLOCKED] — серый оттенок (`opacity-60`) |

> **Примечание (З-34)**: Из заказа стол определяется автоматически. Одно нажатие = действие. Модалка выбора стола **не отображается** — стол уже известен.

---

## D2. Точка входа «Дополнения»: прототип двух контекстов

> **Замечания**: З-33, З-34, З-37
> **Источник**: Кирилл (встреча 11.02): два контекста вызова плагина

### ИЗМЕНИТЬ: каркас POS-терминала (раздел 2.1 и 6.1 базового промта)

Прототип **НЕ отрисовывает** полноценный экран заказа iikoFront (он неизвестен). Прототип показывает **два режима** через переключатель в демо-панели.

**Добавить переключатель контекстов (SegmentedControl) в верхнюю часть экрана:**

```html
<!-- Переключатель контекста (демо-навигация) -->
<div class="flex justify-center gap-2 p-3 bg-[#1a1a1a] border-b border-gray-600">
  <button (click)="context = 'order'"
    [ngClass]="context === 'order' ? 'bg-[#b8c959] text-black' : 'bg-[#2d2d2d] text-gray-300'"
    class="px-4 py-2 rounded text-sm font-medium transition-colors">
    Из заказа (Стол №3)
  </button>
  <button (click)="context = 'main'"
    [ngClass]="context === 'main' ? 'bg-[#b8c959] text-black' : 'bg-[#2d2d2d] text-gray-300'"
    class="px-4 py-2 rounded text-sm font-medium transition-colors">
    Главный экран
  </button>
</div>
```

**Поведение:**

| Контекст      | `context` | Каркас экрана                                                                                        | Панель кнопок PUDU                              |
| ------------- | --------- | ---------------------------------------------------------------------------------------------------- | ----------------------------------------------- |
| Из заказа     | `'order'` | Как в v1.0: header заказа + список блюд + итого                                                      | 3 кнопки: Отправить меню, Уборка, Доставка блюд |
| Главный экран | `'main'`  | Заглушка главного экрана: `bg-[#2d2d2d]`, текст «Главный экран iikoFront» по центру, `text-gray-400` | 2 кнопки: Маркетинг, Уборка (выбор столов)      |

**Панель кнопок меняется в зависимости от контекста:**

Контекст «Из заказа» (3 кнопки, `grid grid-cols-3 gap-3`):
```html
<div class="grid grid-cols-3 gap-3 p-4 border-t border-gray-600">
  <button>Отправить меню</button>
  <button>Уборка посуды</button>
  <button class="opacity-60">Доставка блюд</button>
</div>
```

Контекст «Главный экран» (2 кнопки, `grid grid-cols-2 gap-3`):
```html
<div class="grid grid-cols-2 gap-3 p-4 border-t border-gray-600">
  <button>Маркетинг</button>
  <button>Уборка (выбор столов)</button>
</div>
```

### ДОБАВИТЬ переменную контекста в State

```typescript
type PuduContextType = 'order' | 'main';
currentContext: PuduContextType = 'order'; // По умолчанию — из заказа (как в v1.0)
```

### ОБНОВИТЬ State-машину (раздел 2.2)

Добавить новый тип модалки:

```typescript
type PuduModalType =
  // ... все существующие из v1.0 ...
  | 'cleanup_multi_select'     // NEW: Мультивыбор столов для уборки (главный экран)
  | null;
```

### ОБНОВИТЬ карту переходов (раздел 2.3)

**ДОБАВИТЬ** ветку для главного экрана:

```
Главный экран (context === 'main', activeModal = null)
│
├── Клик «Маркетинг» ─►
│   └── Переключение индикатора круиза (без модалки)
│
└── Клик «Уборка (выбор столов)» ─►
    └── activeModal = 'cleanup_multi_select'
        │
        ├── Выбрано 0 столов → Кнопка «Отправить» disabled
        ├── Выбрано 1+ столов → «Отправить» active
        │   └── «Отправить» ──► 'loading' (3 сек)
        │       ├── Успех ──► 'success' ──► null
        │       └── Ошибка ──► 'error'
        └── «Отмена» ──► null
```

---

## D3. Мультивыбор столов для уборки

> **Замечание**: З-35
> **Источник**: Олег (39:48): «Уборка посуды может включать прям несколько столиков. Там официант кликнет условно уборка столов и там кликнет стол 1, 2, 3 и робот поедет по ним»

### ДОБАВИТЬ: Диалог М12 — Мультивыбор столов для уборки (cleanup_multi_select)

**Приоритет**: **Should** | **Размер**: LG (600px) | **Тема**: Тёмная

**Заголовок**: «Уборка посуды»
**Подзаголовок**: «Выберите столы для уборки»

**Body** (`space-y-5 mb-6`):

1. **Сетка столов** (интерактивные карточки-кнопки):

```html
<div class="grid grid-cols-3 gap-3">
  <!-- Замапленный стол (кликабельный) -->
  <button *ngFor="let table of mappedTables"
    (click)="toggleTableSelection(table)"
    [ngClass]="isSelected(table) ? 'border-[#b8c959] bg-[#b8c959]/20' : 'border-gray-600 bg-[#2d2d2d]'"
    class="border-2 rounded-lg p-3 text-center transition-all">
    <lucide-icon *ngIf="isSelected(table)" name="check-circle-2" [size]="20" class="text-[#b8c959] mx-auto mb-1"></lucide-icon>
    <p class="text-sm font-medium text-white">{{ table.table_name }}</p>
  </button>

  <!-- НЕзамапленный стол (disabled) -->
  <div *ngFor="let table of unmappedTables"
    class="border-2 border-gray-700 bg-[#1a1a1a] rounded-lg p-3 text-center opacity-40 cursor-not-allowed">
    <p class="text-sm text-gray-500">{{ table.table_name }}</p>
    <p class="text-xs text-gray-600">Не настроен</p>
  </div>
</div>
```

2. **Счётчик выбранных столов**:

```html
<p class="text-sm text-gray-300 text-center">
  Выбрано столов: <span class="text-[#b8c959] font-bold">{{ selectedTables.length }}</span>
</p>
```

**Footer** — стандартная пара:
- «Отмена» (`bg-[#1a1a1a]`) → `activeModal = null`
- «Отправить робота» (`bg-[#1a1a1a]`, disabled когда `selectedTables.length === 0`) → `activeModal = 'loading'`

**При disabled** кнопка «Отправить робота» → `opacity-50 cursor-not-allowed`.

**Интерактивность прототипа:**
- Только замапленные столы кликабельны (toggle-выбор)
- Незамапленные столы серые, с пометкой «Не настроен»
- При нажатии «Отправить робота» → Loading 3 сек → Success (автозакрытие 2 сек)
- Карточка робота в Loading/Success: указывает **первый idle** робот (`getAssignedRobot()`)

---

## D4. Обработка E-STOP: повторяющееся уведомление

> **Замечание**: З-40
> **Источник**: Руслан NE (46:10): «Это красная кнопка. Если кто-то её нажимает, робот останавливается и перестаёт выполнять все задания»; Кирилл (47:03): «Мы можем продублировать ошибку»; Руслан NE (~47:12): «Если её закрыли, официант, чтобы она ещё раз показала, что этот робот не активен»

### ДОБАВИТЬ: Механизм повторяющегося E-STOP уведомления

**Отличие от обычных ошибок**: уведомление E-STOP **не является одноразовым**. При закрытии (dismiss) уведомления — оно **появляется снова** через 5 секунд, пока состояние E-STOP не снято.

**Интерфейс уведомления (расширить `PuduNotification`):**

```typescript
interface PuduNotification {
  id: string;
  type: 'error';
  title: string;
  message: string;
  timestamp: Date;
  dismissed: boolean;
  is_estop: boolean;              // NEW: true = повторяющееся уведомление E-STOP
  repeat_interval_sec?: number;   // NEW: интервал повторения (5 сек для E-STOP)
}
```

**UI E-STOP уведомления (Toast, правый нижний угол):**

```html
<!-- E-STOP: красная плашка с повышенным приоритетом -->
<div class="fixed bottom-6 right-6 z-[60] animate-slide-up">
  <div class="bg-red-600 text-white rounded-lg p-4 shadow-lg max-w-sm flex items-start gap-3 border-2 border-red-400">
    <lucide-icon name="octagon" [size]="24" class="shrink-0 text-white mt-0.5"></lucide-icon>
    <div class="flex-1">
      <p class="text-sm font-bold">E-STOP: Робот {{ robotName }} остановлен</p>
      <p class="text-xs text-red-100 mt-1">Красная кнопка нажата. Робот прекратил выполнение всех задач. Обратитесь к инженеру.</p>
      <p class="text-xs text-red-200 mt-2 italic">Уведомление будет повторяться до устранения проблемы</p>
    </div>
    <button (click)="dismissEstop()" class="text-red-200 hover:text-white transition-colors">
      <lucide-icon name="x" [size]="16"></lucide-icon>
    </button>
  </div>
</div>
```

**Логика mock повторения:**
```typescript
// При dismiss E-STOP — повторное появление через 5 сек
dismissEstop() {
  this.estopNotification.dismissed = true;
  setTimeout(() => {
    if (this.isEstopActive) {  // Имитация: E-STOP всё ещё активен
      this.estopNotification.dismissed = false;
      this.estopNotification.timestamp = new Date();
    }
  }, 5000);
}
```

**Визуальные отличия E-STOP от обычных ошибок:**

| Параметр          | Обычная ошибка  | E-STOP                                                 |
| ----------------- | --------------- | ------------------------------------------------------ |
| Фон               | `bg-red-500/90` | `bg-red-600` + `border-2 border-red-400`               |
| Иконка            | `alert-circle`  | `octagon` (знак СТОП)                                  |
| Текст модификатор | —               | `font-bold` заголовок                                  |
| Повторение        | Одноразовое     | **Повторяется** каждые 5 сек до устранения             |
| Подпись           | —               | «Уведомление будет повторяться до устранения проблемы» |

### ДОБАВИТЬ кнопку в демо-панель (раздел 9.1)

| #   | Кнопка демо        | Действие                                                                      | Стиль                                     |
| --- | ------------------ | ----------------------------------------------------------------------------- | ----------------------------------------- |
| 5   | «Имитация: E-STOP» | Toggle `isEstopActive`. При true → push E-STOP уведомление. При false → снять | `text-xs text-red-400 hover:text-red-300` |

---

## D5. Кастомные ошибки NE: mock-примеры

> **Замечание**: З-39
> **Источник**: Олег (44:36): «Будут кастомные ошибки, условно, когда в робота кто-то зайдёт... мы будем вам откидывать ошибку»

### ДОБАВИТЬ: Расширение mock-уведомлений

Добавить в `mockNotifications` (раздел 5.7) новые примеры кастомных ошибок NE:

```typescript
const mockNotifications: PuduNotification[] = [
  // ... существующие из v1.0 ...
  {
    id: "notif-003",
    type: "error",
    title: "Робот BellaBot-01: ручной режим",
    message: "Кто-то зашёл в настройки робота через физическое меню. Робот переведён в ручной режим и недоступен для задач",
    timestamp: new Date('2026-02-11T14:25:00'),
    dismissed: false,
    is_estop: false
  },
  {
    id: "notif-004",
    type: "error",
    title: "Робот Ketty-02: препятствие на маршруте",
    message: "Робот не может продолжить движение — обнаружено препятствие. Код: OBSTACLE_DETECTED",
    timestamp: new Date('2026-02-11T14:26:00'),
    dismissed: false,
    is_estop: false
  },
  {
    id: "notif-005",
    type: "error",
    title: "Робот BellaBot-01: низкий заряд батареи",
    message: "Уровень заряда < 10%. Робот возвращается на станцию зарядки. Код: LOW_BATTERY",
    timestamp: new Date('2026-02-11T14:27:00'),
    dismissed: false,
    is_estop: false
  }
];
```

### ДОБАВИТЬ кнопку в демо-панель (раздел 9.1)

| #   | Кнопка демо                     | Действие                                                              | Стиль                                           |
| --- | ------------------------------- | --------------------------------------------------------------------- | ----------------------------------------------- |
| 6   | «Имитация: Кастомные ошибки NE» | Циклический push mock-уведомлений (notif-003 → notif-004 → notif-005) | `text-xs text-orange-400 hover:text-orange-300` |

### ДОБАВИТЬ: Маппинг кодов ошибок NE (справочный)

> **Примечание**: Полный каталог кастомных ошибок будет предоставлен NE (открытый вопрос НВ-04). Ниже — предварительный маппинг для mock:

```typescript
const neErrorCodeMap: Record<string, { title: string; message: string }> = {
  'MANUAL_MODE':       { title: "Ручной режим",          message: "Кто-то зашёл в настройки робота. Недоступен для задач" },
  'OBSTACLE_DETECTED': { title: "Препятствие на маршруте", message: "Робот не может продолжить движение" },
  'LOW_BATTERY':       { title: "Низкий заряд батареи",   message: "Уровень заряда < 10%. Робот на зарядке" },
  'ROBOT_STUCK':       { title: "Робот застрял",          message: "Проверьте препятствия на маршруте" },
  'NE_API_ERROR':      { title: "Сервер NE недоступен",   message: "NE API не отвечает. Повтор через 5 сек..." },
  'ESTOP_PRESSED':     { title: "E-STOP нажат",           message: "Красная кнопка. Все задачи остановлены" },
};
```

---

## D6. [СНЯТ] Success-уведомление

> **Допущение на основе общей логики**: убрать success-уведомление при выполнении задачи

### СТАТУС: [СНЯТ]

**Обоснование**: В промте v1.0 (раздел 3.7) уже зафиксировано:

> «Уведомления показываются **только при ошибках**. Успешное завершение задачи — **без уведомления** (решение Руслана, чтобы не «задолбить» официантов уведомлениями)»

Toast-уведомления об успехе **уже отсутствуют** в v1.0. Диалог М10 (Success Dialog) — это **модальное окно** (не toast), которое закрывается автоматически через 2 сек и обеспечивает визуальную обратную связь. М10 **сохраняется** — он необходим для UX-цепочки: Loading → Success → экран кассы.

**Никаких изменений не требуется.**

---

## D7. Обновление модальных окон

### D7.1. Диалог М1 — Отправить меню: добавить фразу при заборе

> **Замечание**: З-15
> **Источник**: Документ «IIKO web»: «Нужно добавить фразу для официанта, когда робот подъехал к забору меню, он должен попросить положить на него меню для определённого стола»

### ИЗМЕНИТЬ: М1 (send_menu_confirm) — карточка информации

Добавить строку «Фраза при заборе» в карточку:

```html
<div class="bg-white text-black p-4 rounded space-y-2">
  <div class="flex justify-between">
    <span class="text-sm text-gray-600">Стол</span>
    <span class="text-sm font-medium">Стол №3 (VIP)</span>
  </div>
  <div class="flex justify-between">
    <span class="text-sm text-gray-600">Робот</span>
    <span class="text-sm font-medium">BellaBot-01</span>
  </div>
  <div class="flex justify-between">
    <span class="text-sm text-gray-600">Фраза у стола</span>
    <span class="text-sm font-medium italic">«Заберите, пожалуйста, меню»</span>
  </div>
  <!-- NEW: фраза при заборе меню -->
  <div class="h-px bg-gray-200"></div>
  <div class="flex justify-between">
    <span class="text-sm text-gray-600">Фраза при заборе</span>
    <span class="text-sm font-medium italic">«Положите меню для стола №3»</span>
  </div>
</div>
```

> **Примечание**: Подстановка номера стола (`{N}` → `3`) выполняется автоматически из контекста заказа.

---

### D7.2. Диалог М2 — Уборка: без изменений для контекста «из заказа»

**Для контекста «Из заказа»**: диалог М2 (cleanup_confirm) **не меняется** — используется один стол из контекста.

**Для контекста «Главный экран»**: мультивыбор столов реализован в **новом** диалоге М12 (см. D3).

---

### D7.3. Диалоги М3/М4 (QR) — без изменений

QR-фазы «Кассир» (М3) и «Гость» (М4) остаются **без изменений**. Автоматический триггер при фискализации СБП (З-36) уже покрыт демо-кнопкой в v1.0.

> **Примечание (З-36)**: Автоматическая отправка робота при фискализации с поддержкой QR — **требует подтверждения NE (НВ-14)**. В прототипе имитируется через демо-кнопку «Имитация: QR-оплата (СБП)».

---

## D8. Обновление mock-данных и типов

### D8.1. Обновление интерфейса `PuduRobot`

> **Замечание**: З-43 — `after_action` выносится как per-robot настройка

**ИЗМЕНИТЬ** (`types.ts`):

```typescript
// Робот PUDU (v1.1)
interface PuduRobot {
  robot_id: string;              // "PD2024060001"
  robot_name: string;            // "BellaBot-01"
  status: 'idle' | 'busy' | 'offline';
  after_action: 'idle' | 'marketing';  // NEW: per-robot, из Admin Panel
}
```

### D8.2. Обновление mock-данных роботов

```typescript
const mockRobots: PuduRobot[] = [
  { robot_id: "PD2024060001", robot_name: "BellaBot-01", status: "idle",    after_action: "idle" },
  { robot_id: "PD2024080042", robot_name: "Ketty-02",    status: "busy",    after_action: "marketing" }
];
```

### D8.3. Обновление `PuduModalType`

```typescript
type PuduModalType =
  // Сценарий: Отправить меню
  | 'send_menu_confirm'
  // Сценарий: Уборка посуды
  | 'cleanup_confirm'             // Из заказа — один стол
  | 'cleanup_multi_select'        // NEW: С главного экрана — мультивыбор
  // Сценарий: Оплата по QR
  | 'qr_cashier_phase'
  | 'qr_guest_phase'
  | 'qr_success'
  | 'qr_timeout'
  // Сценарий: Доставка блюд [BLOCKED]
  | 'send_dish_blocked'
  // Общие
  | 'loading'
  | 'error'
  | 'success'
  | 'unmapped_table'
  | null;
```

### D8.4. Обновление `PuduNotification`

```typescript
interface PuduNotification {
  id: string;
  type: 'error';
  title: string;
  message: string;
  timestamp: Date;
  dismissed: boolean;
  is_estop: boolean;              // NEW: повторяющееся уведомление E-STOP
  repeat_interval_sec?: number;   // NEW: интервал повторения (5 сек для E-STOP)
}
```

### D8.5. Обновление `RobotTask.status` — маппинг к NE API

> **Замечание**: З-42 — новый endpoint `GET /v1/scenarios/scenario-status`

**ДОБАВИТЬ** значение `'finished'` и комментарий маппинга:

```typescript
interface RobotTask {
  task_id: string;
  task_type: 'send_menu' | 'cleanup' | 'qr_payment' | 'send_dish' | 'marketing';
  // Маппинг к NE API (GET /v1/scenarios/scenario-status):
  // NE IN_PROCESS → 'queued' | 'assigned' | 'in_progress' | 'at_cashier' | 'at_target'
  // NE FAILED     → 'error'
  // NE SUCCESS    → 'completed'
  // NE FINISHED   → 'finished' (маркетинг, остановлен пользователем)
  // NE CANCELED   → 'cancelled'
  status: 'queued' | 'assigned' | 'in_progress' | 'at_cashier' | 'at_target'
        | 'completed' | 'error' | 'cancelled' | 'finished'
        | 'cashier_timeout' | 'payment_timeout';
  table_id: string;
  robot_name: string;
  created_at: Date;
}
```

### D8.6. Обновление `mockScenarioSettings` — удалить `after_action` и `general`

> **Замечания**: З-43 (after_action per-robot), З-31 (general удалена из MVP), З-12 (URL видео/аудио)

```typescript
const mockScenarioSettings = {
  send_menu: {
    phrase: "Заберите, пожалуйста, меню",
    phrase_url: "",                           // NEW: URL видео/аудио
    phrase_pickup: "Положите меню для стола №{N}",  // NEW: фраза при заборе (З-15)
    phrase_pickup_url: "",                    // NEW: URL видео/аудио
    wait_time: 30,
    wait_time_pickup: 30                     // NEW: время ожидания на pickup (З-16)
    // after_action — УДАЛЕНО (перенесено per-robot)
  },
  cleanup: {
    mode: "manual",                          // NEW: режим уборки (manual/auto/mixed), из Admin Panel
    phrase_arrival: "Пожалуйста, поставьте грязную посуду на поднос",
    phrase_arrival_url: "",                   // NEW: URL видео/аудио
    wait_time: 90,
    phrase_later: "Я приеду позже за посудой",
    phrase_later_url: ""                     // NEW: URL видео/аудио
  },
  qr_payment: {
    cashier_phrase: "Положите чек для стола {N}",
    cashier_phrase_url: "",                   // NEW: URL видео/аудио
    cashier_timeout: 30,
    guest_wait_time: 120,
    phrase_success: "Спасибо за оплату!",
    phrase_success_url: "",                   // NEW: URL видео/аудио
    phrase_failure: "К сожалению, оплата не прошла. Обратитесь к официанту",
    phrase_failure_url: ""                   // NEW: URL видео/аудио
    // after_action — УДАЛЕНО (перенесено per-robot)
  },
  marketing: {
    robot_id: "PD2024080042",
    auto_cruise_on_idle: true
  }
  // general — УДАЛЕНО из MVP (З-31)
};
```

### D8.7. Автоназначение робота (замена `general.default_robot_id`)

```typescript
// Вместо general.default_robot_id — автоматическое назначение.
// В production робот назначается NE; в прототипе — первый idle.
function getAssignedRobot(): PuduRobot {
  return mockRobots.find(r => r.status === 'idle') || mockRobots[0];
}
```

Все диалоги (М1, М2, М3, М12), где показывается «Робот: BellaBot-01», берут значение из `getAssignedRobot().robot_name`.

### D8.8. Добавить контекстную переменную

```typescript
type PuduContextType = 'order' | 'main';

// В корневом компоненте:
currentContext: PuduContextType = 'order';
isEstopActive: boolean = false;
selectedTablesForCleanup: OrderTable[] = [];
```

---

## Сводная таблица изменений

| #    | Раздел / Компонент | Изменение                                                                                                                                                                                      | Замечания              | Тип           |
| ---- | ------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------- | ------------- |
| D1   | Архитектура        | Два контекста: Главный экран (маркетинг + уборка мульти) и Из заказа (меню, уборка 1 стол, доставка)                                                                                           | З-33, З-35, З-37       | Добавление    |
| D2   | Каркас POS         | Переключатель контекстов (SegmentedControl). Панель кнопок меняется. Главный экран — заглушка                                                                                                  | З-33, З-34             | Изменение     |
| D3   | Модалка М12        | NEW: Мультивыбор столов для уборки (сетка, toggle, счётчик)                                                                                                                                    | З-35                   | Добавление    |
| D4   | Уведомления        | E-STOP: повторяющееся уведомление (иконка `octagon`, border-red-400, re-show 5 сек)                                                                                                            | З-40                   | Добавление    |
| D5   | Mock-уведомления   | 3 новых кастомных ошибки NE + маппинг кодов                                                                                                                                                    | З-39                   | Добавление    |
| D6   | ~~Success toast~~  | **[СНЯТ]** — уже реализовано в v1.0                                                                                                                                                            | —                      | Не применимо  |
| D7.1 | Модалка М1         | Добавить строку «Фраза при заборе» в карточку                                                                                                                                                  | З-15                   | Изменение     |
| D7.2 | Модалка М2         | Без изменений (из заказа = 1 стол)                                                                                                                                                             | —                      | Без изменений |
| D7.3 | Модалки М3/М4      | Без изменений                                                                                                                                                                                  | З-36 (НВ-14)           | Без изменений |
| D8   | Mock-данные, типы  | `PuduRobot` + `after_action`; `PuduNotification` + `is_estop`; `RobotTask.status` + `finished`; удалить `after_action` из settings; удалить `general`; добавить URL-поля; `getAssignedRobot()` | З-12, З-31, З-42, З-43 | Изменение     |

---

## Обновлённая демо-панель (полная, v1.1)

| #   | Кнопка демо                 | Действие                                    | Стиль                                           |
| --- | --------------------------- | ------------------------------------------- | ----------------------------------------------- |
| 1   | «Имитация: QR-оплата (СБП)» | `activeModal = 'qr_cashier_phase'`          | `text-xs text-gray-400 hover:text-white`        |
| 2   | «Имитация: Ошибка»          | Push mock-уведомление об ошибке             | `text-xs text-gray-400 hover:text-white`        |
| 3   | «Стол замаплен: Да/Нет»     | Toggle `currentOrder.table.is_mapped`       | `text-xs text-gray-400 hover:text-white`        |
| 4   | «Сменить стол»              | Циклический переключатель mock-столов       | `text-xs text-gray-400 hover:text-white`        |
| 5   | **«Имитация: E-STOP»**      | Toggle `isEstopActive` — E-STOP уведомление | `text-xs text-red-400 hover:text-red-300`       |
| 6   | **«Имитация: Ошибки NE»**   | Циклический push кастомных ошибок           | `text-xs text-orange-400 hover:text-orange-300` |

---

## Обновлённый итоговый чеклист прототипа (дельта к v1.0)

### Новое: Контексты вызова
- [ ] Переключатель контекстов: «Из заказа» / «Главный экран» (SegmentedControl)
- [ ] Контекст «Из заказа»: 3 кнопки (меню, уборка, доставка блюд). Каркас заказа из v1.0
- [ ] Контекст «Главный экран»: 2 кнопки (маркетинг, уборка мульти). Заглушка главного экрана

### Новое: Мультивыбор столов
- [ ] М12: Диалог мультивыбора столов (LG, тёмная)
- [ ] Сетка столов: замапленные (кликабельные, toggle) / незамапленные (disabled, серые)
- [ ] Счётчик «Выбрано столов: N»
- [ ] Кнопка «Отправить» disabled при 0 выбранных

### Новое: E-STOP
- [ ] E-STOP уведомление: иконка `octagon`, `bg-red-600`, border, font-bold
- [ ] Повторение уведомления через 5 сек после dismiss
- [ ] Подпись «Уведомление будет повторяться до устранения проблемы»
- [ ] Демо-кнопка toggle E-STOP

### Новое: Кастомные ошибки NE
- [ ] 3 mock-уведомления (ручной режим, препятствие, низкий заряд)
- [ ] Маппинг кодов ошибок NE → тексты
- [ ] Демо-кнопка циклического push

### Изменённое: Модалки
- [ ] М1: добавлена строка «Фраза при заборе» в карточку
- [ ] М2: без изменений (из заказа = 1 стол)
- [ ] М3/М4: без изменений

### Изменённое: Mock-данные
- [ ] `PuduRobot`: добавлено `after_action` per-robot
- [ ] `PuduNotification`: добавлены `is_estop`, `repeat_interval_sec`
- [ ] `RobotTask.status`: добавлен `'finished'`, комментарий маппинга к NE API
- [ ] `mockScenarioSettings`: удалены `after_action` из send_menu и qr_payment; удалён `general`; добавлены URL-поля, фраза pickup, время pickup
- [ ] `getAssignedRobot()` вместо `general.default_robot_id`

### Подтверждено (без изменений)
- [ ] Toast успеха уже отсутствует (v1.0). М10 Success Dialog сохранён
- [ ] QR auto-trigger покрыт демо-кнопкой (З-36, НВ-14)

---

## Открытые вопросы (новые, добавить в спецификации)

| #     | Вопрос                                                                                                 | Критичность                | Адресат            |
| ----- | ------------------------------------------------------------------------------------------------------ | -------------------------- | ------------------ |
| НВ-15 | **Доступна ли «Уборка» с главного экрана?** Если нет — мультивыбор столов из З-35 не имеет точки входа | **Высокая** (блокер D1/D3) | Руслан / Олег (NE) |

---

## Обновлённая структура файлов (дельта)

```
src/app/prototypes/iiko-front-pudu-plugin/
├── ...существующие файлы из v1.0...
├── components/
│   ├── context-switcher.component.ts       # NEW: переключатель контекстов
│   ├── main-screen-stub.component.ts       # NEW: заглушка главного экрана
│   ├── pudu-buttons-panel.component.ts     # CHANGED: панель зависит от контекста
│   ├── error-toast.component.ts            # CHANGED: поддержка E-STOP повторения
│   └── dialogs/
│       └── cleanup-multi-select.component.ts  # NEW: М12 мультивыбор столов
├── data/
│   └── mock-data.ts                         # CHANGED: обновлённые mock-данные
│   └── ne-error-codes.ts                    # NEW: маппинг кодов ошибок NE
└── types.ts                                 # CHANGED: обновлённые интерфейсы
```

---

## История изменений

| Версия | Дата       | Автор        | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| ------ | ---------- | ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.0    | 2026-02-11 | Кирилл Тюрин | Первая версия промта: полное описание прототипа плагина iikoFront с 12 модальными окнами, state-машиной, mock-данными, POS-стилистикой                                                                                                                                                                                                                                                                                                                                          |
| 1.1    | 2026-02-13 | Кирилл Тюрин | **Промт-патч по итогам встречи 11.02**: два контекста вызова плагина (З-33) — «Из заказа» (меню, уборка, доставка) и «Главный экран» (маркетинг + уборка мульти); мультивыбор столов для уборки М12 (З-35); E-STOP повторяющееся уведомление (З-40); кастомные ошибки NE mock (З-39); фраза при заборе меню в М1 (З-15); обновление mock-данных: per-robot after_action (З-43), удалён general (З-31), URL видео/аудио (З-12), маппинг NE-статусов (З-42); D6 снят (уже в v1.0) |
