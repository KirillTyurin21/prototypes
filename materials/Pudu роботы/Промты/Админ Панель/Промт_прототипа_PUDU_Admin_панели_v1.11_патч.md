# Промт-патч v1.11: Правки по встрече 18.02 — credentials, ошибка 404, маппинг «Точки → Столы», marketing, phrase_pickup

---
**Версия**: 1.11
**Дата**: 2026-02-26
**Автор**: Кирилл Тюрин (системный аналитик)
**Статус**: [PENDING]
**Артефакт**: Д3-патч (Промт-патч для обновления прототипа iikoWeb)
**Базовый документ**: Промт_прототипа_PUDU_Admin_панели_v1.10_патч.md (v1.10, 2026-02-18)
**Источники**: SPEC-002 v1.19 (разделы 2.5, 2.6.13, 2.6.14, 5.3, 5.5, 6, 7.1, 7.2, 7.6, 7.6a, 4); стенограмма встречи 18.02.2026; `2026-02-26-правки-SPEC-002-по-встрече-18-02.md` (П-1, П-2, П-3, П-4, П-5, П-6)
**Scope**: Э0 (Б0): удаление credentials UI; Э2: текст ошибки 404; Э3 (Б2): маппинг «Точки → Столы»; Э4 (Б3): удаление вкладки «Маркетинг», обновление phrase_pickup; Э1 (Б5): tooltip after_action
---

## Назначение

Этот документ — **дельта-патч** к промту v1.10 (через цепочку v1.1 → v1.10). Он реализует три решения, принятых на встрече 18.02.2026:

**П-1 [Critical]** — Удаление UI ввода credentials (`client_id` + `api_secret`) из экрана Э0 (Б0). Параметры `api_key` и `api_secret` — глобальные системные константы, зашиваемые при развёртывании. Администратору не нужен UI для их ввода.

> **Олег NE** (18.02): *«API-ключ и API-секрет — это ваши внутренние [константы] по системе нашей. Они постоянные.»*

**П-2 [Must]** — Единая формулировка ошибки 404 при регистрации робота. NE не может различить причины отказа (неверный ID или робот в чужом магазине), поэтому текст должен покрывать оба случая.

> **Олег NE** (18.02): *«Универсальная будет, да. Мы не можем знать... Либо его не будет, либо он неправильный ID-шник.»*

**П-3 [Must]** — Утверждён вариант маппинга «Точки → Столы»: слева — точки робота (read-only), справа — UiSelect стола iiko.

> **Руслан** (18.02): *«Ну, значит, давайте этот вариант оставим.»*

**П-4 [Must]** — Убрана переменная `{N}` из фразы pickup в send_menu. Фраза становится полностью статической: `"Положите меню для стола"`.

> **Руслан** (18.02): *«Давайте просто оставим "положить меню для стола". Всё.»*

**П-5 [Critical]** — Полное удаление вкладки «Маркетинг» из экрана Э4 (Б3). Маркетинг управляется исключительно через `after_action` per-robot на Б5. Без таймеров, расписания, `idle_timeout_sec`.

> **Руслан** (18.02): *«Может быть, вообще этот маркетинг убрать отсюда [вкладка] и оставить в том варианте [after_action на роботе].»*

**П-6 [Should]** — NE автоматически перераспределяет роботов из маркетинга в рабочие задачи при нехватке свободных роботов. Панель iiko не управляет этой логикой.

> **Руслан** (18.02): *«Четвёртого с маркетинга программа сама снимает, какого хочет.»*

**Инструкция по применению**: сначала примени базовый промт v1.1, затем патчи v1.2 → ... → v1.10 → затем этот патч v1.11 — последовательно.

**Ключевые изменения v1.11:**
- [П-1] Удалены: NeConnectionCard, NeCredentialsModal, soft-block на Э0
- [П-1] Удалены: Toast #14, #15, #16 (credentials)
- [П-2] Обновлён текст Alert 404 на Э2 (модалка регистрации)
- [П-3] Удалён SegmentedControl направления маппинга на Э3
- [П-3] Таблица маппинга перестроена: «Точки → Столы» (point = row, table = UiSelect)
- [П-3] Удалены кнопки «+ Точку» и «x» — каждая точка имеет ровно один UiSelect
- [П-4] Обновлён default `phrase_pickup` в mock: `"Положите меню для стола"` (без `{N}`)
- [П-5] Удалена вкладка «Маркетинг» из Э4: 5 → 4 вкладки
- [П-5] Удалены: `idle_timeout_sec`, info-блок after_action, marketing mock-данные
- [П-5] Обновлён TypeScript интерфейс `ScenarioSettings` — удалён `MarketingSettings`
- [П-6] Добавлено бизнес-правило в tooltip `after_action` на Э1 (Б5)

---

## Совместимость с предыдущими патчами

| Патч           | Совместимость   | Примечание                                                                                  |
| -------------- | --------------- | ------------------------------------------------------------------------------------------- |
| v1.1 (базовый) | Требуется       | Базовые экраны Э0–Э4                                                                        |
| v1.2 (C1–C10)  | Требуется       | C6: SegmentedControl маппинга (удаляется N6). C10: регистрация 2 поля (обновляется N5)      |
| v1.3 (E1–E5)   | Требуется       | E1–E5: технические ID, эксклюзивность точек (переработано N7–N8)                            |
| v1.4 (F1–F13)  | Требуется       | F1–F4: Э0, двухуровневая навигация. F13: фильтр по залу (обновляется N8)                    |
| v1.7 (J1–J5)   | **Конфликтует** | J1–J5: Multi-Select robot_ids на вкладке Marketing — **удаляется** (N11)        |
| v1.8 (K1–K8)   | **Конфликтует** | K1–K8: NeConnectionCard, NeCredentialsModal, Toast #14–16 — **удаляются** полностью (N1–N4) |
| v1.9 (L1–L8)   | Совместим       | L1–L8: ручной ввод стола — сохраняется, перемещён в отдельную секцию                        |
| v1.10 (M1–M4)  | **Конфликтует** | M1–M4: `idle_timeout_sec`, info-блок after_action, marketing mock — **удаляются** (N11–N12) |

**Перекрёстный конфликт v1.8**: Патч v1.8 добавлял NeConnectionCard, NeCredentialsModal и Toast #14–16. Данный патч v1.11 полностью **откатывает** эти добавления. При генерации прототипа рекомендуется **пропустить** v1.8, либо применить v1.8, затем v1.11 (N1–N4 удалят всё добавленное).

---

## Блоки изменений

### N1. [П-1] Удалить NeConnectionCard с экрана Э0

**Файл**: `app/page.tsx` (экран Э0 — Список ресторанов)

### УДАЛИТЬ

Полностью удалить компонент `NeConnectionCard` из разметки Э0. Компонент отображался в верхней части до таблицы ресторанов и имел 3 состояния (`connected`, `not_configured`, `error`).

```tsx
{/* УДАЛИТЬ ВЕСЬ БЛОК NeConnectionCard */}
{/* Карточка статуса подключения к NE — 3 состояния:
    - connected: зелёный бейдж "Подключено", кнопка "Изменить"
    - not_configured: alert "Подключение не настроено", кнопка "Настроить"
    - error: красный бейдж "Ошибка", кнопка "Обновить данные"
*/}
```

Если компонент вынесен в отдельный файл (`components/ne-connection-card.tsx`), файл тоже удалить.

**Обоснование**: Credentials — системные константы. Администратор видит Э0 сразу в рабочем состоянии.

---

### N2. [П-1] Удалить NeCredentialsModal

**Файл**: `app/page.tsx` или `components/ne-credentials-modal.tsx`

### УДАЛИТЬ

Полностью удалить модальное окно `NeCredentialsModal`:
- Dialog с двумя полями: `client_id` (text) и `api_secret` (password)
- Кнопка «Проверить и сохранить» со спиннером
- Обработчики: submit, валидация, закрытие
- State: `isCredentialsModalOpen`, `credentialsForm`

```tsx
{/* УДАЛИТЬ ВЕСЬ БЛОК NeCredentialsModal */}
{/* Модалка ввода client_id + api_secret с проверкой через NE API */}
```

Если компонент вынесен в отдельный файл, файл тоже удалить.

---

### N3. [П-1] Убрать soft-block таблицы ресторанов

**Файл**: `app/page.tsx`

### УДАЛИТЬ

Убрать условие soft-блокировки, которое блокировало клик по строке ресторана, если подключение к NE не настроено (`ne_status !== 'connected'`):

```tsx
{/* УДАЛИТЬ условие блокировки */}
{/* Условие: если ne_status !== 'connected', строки таблицы ресторанов
    отображаются `opacity-50 cursor-not-allowed` и клик не работает */}
```

**СТАЛО**: Строки таблицы ресторанов **всегда** кликабельны, без проверки статуса NE.

---

### N4. [П-1] Удалить Toast #14, #15, #16

**Файл**: Файл с toast-уведомлениями / обработчиками credentials

### УДАЛИТЬ

Убрать 3 toast-уведомления, привязанных к сохранению credentials:

| #   | Текст                                          | Стиль                | Действие |
| --- | ---------------------------------------------- | -------------------- | -------- |
| 14  | «Подключение к NE настроено»                   | default              | УДАЛИТЬ  |
| 15  | «Ошибка подключения. Проверьте учётные данные» | destructive          | УДАЛИТЬ  |
| 16  | «Сервис NE временно недоступен»                | **warning** (orange) | УДАЛИТЬ  |

**Актуальный реестр Toast** после удаления: 15 шт (были 18, удалены #14, #15, #16).

---

### N5. [П-2] Обновить текст ошибки 404 в Э2 (модалка регистрации)

**Файл**: `components/robots/robot-register-modal.tsx`

**Расположение**: Alert, отображаемый при получении HTTP 404 от POST /api/pudu/robots/register.

### БЫЛО

```tsx
<Alert variant="destructive">
  <AlertCircle className="h-4 w-4" />
  <AlertDescription>
    Робот не найден в системе PUDU. Обратитесь к специалистам NE для добавления робота в магазин
  </AlertDescription>
</Alert>
```

### СТАЛО

```tsx
<Alert variant="destructive">
  <AlertCircle className="h-4 w-4" />
  <AlertDescription>
    Робот не найден. Проверьте ID робота. Если данные верны — обратитесь в Next Era для уточнения
  </AlertDescription>
</Alert>
```

**Обоснование**: NE не различает причины 404 (неверный ID / робот у чужого дилера). Текст покрывает оба случая.

---

### N6. [П-3] Удалить SegmentedControl направления маппинга с Э3

**Файл**: `app/mapping/page.tsx`

### УДАЛИТЬ

Полностью удалить `SegmentedControl` (переключатель «Столы → Точки» / «Точки → Столы»), добавленный в v1.2 (C6):

```tsx
{/* УДАЛИТЬ ВЕСЬ БЛОК SegmentedControl */}
{/* Переключатель направления маппинга:
    - «Столы → Точки» (tables_to_points)
    - «Точки → Столы» (points_to_tables)
    Расположен в subheader рядом с кнопкой «Обновить точки»
*/}
```

Также удалить связанный state: `mappingDirection: 'tables_to_points' | 'points_to_tables'`.

**Обоснование**: Направление утверждено — только «Столы → Точки». Переключатель больше не нужен. Функционал "Столы - Точки" остается как есть.

---


### N9. [П-3] Обновить mock-данные маппинга

**Файл**: Файл с mock-данными

### БЫЛО

Mock-маппинг: `{ table_id, points: string[] }` — массив точек привязанных к каждому столу.

### СТАЛО

Mock-маппинг: `{ point_id, table_id: string | null }` — для каждой точки указан привязанный стол (или `null`).

```typescript
// Маппинг: point_id → table_id
const mockMapping: PointMapping[] = [
  { point_id: "SF234201A", table_id: "t1" },  // → Стол 1
  { point_id: "SF234202B", table_id: "t1" },  // → Стол 1 (два подхода)
  { point_id: "SF234203C", table_id: "t2" },  // → Стол 2
  { point_id: "SF234204D", table_id: "t3" },  // → Стол 3
  { point_id: "SF234205E", table_id: "t4" },  // → Стол 4
  { point_id: "SF234206F", table_id: "t5" },  // → Стол 5
  { point_id: "SF234207G", table_id: "t6" },  // → Стол 6
  { point_id: "SF234208H", table_id: null },   // — не привязана
  { point_id: "SF234209I", table_id: null },   // — не привязана
  { point_id: "SF234210J", table_id: null },   // — не привязана
];

interface PointMapping {
  point_id: string;
  table_id: string | null;
}
```

**Итого**: 10 точек → 7 привязаны, 3 без привязки. Стол 1 получает 2 точки (N:1).

---

## Порядок элементов на Э0 (после патча)

```
1. Subheader: «Настройки PUDU»                                   [существующий]
2.                                                                 [УДАЛЁН — NeConnectionCard (N1)]
3. Строка поиска (debounce 300 мс)                                [существующий]
4. Таблица ресторанов — ВСЕГДА кликабельна                        [обновлён — N3]
```

## Порядок элементов на Э3 (после патча)

```
1. Subheader: «Маппинг столов» + кнопка «Обновить точки»          [существующий]
2.                                                                  [УДАЛЁН — SegmentedControl (N6)]
3. Фильтр «Зал» (фильтрует опции UiSelect, не строки)             [обновлён — N8a]
4. UiAlert (orange): «N точек не имеют привязки...»                [обновлён — N8b]
5. Таблица маппинга: Точка (read-only) | Стол (UiSelect) | Статус [перестроена — N7]
6. Секция «Ручные столы» (чипы с trash-2)                          [обновлено — N8c]
7. Кнопка «+ Ручной стол» + inline-форма                          [существующий — v1.9]
8. Sticky footer: Сохранить / Сбросить                             [существующий]
```

---

### N10. [П-4] Обновить default `phrase_pickup` в mock-данных send_menu (Э4)

**Файл**: `app/settings/page.tsx` (или где хранятся mock-данные `ScenarioSettings`)

### ОБНОВИТЬ

**БЫЛО**:
```tsx
send_menu: {
  phrase_delivery: "Заберите, пожалуйста, меню",
  video_url_delivery: "",
  phrase_pickup: "Положите меню для стола №{N}",
  // ...
}
```

**СТАЛО**:
```tsx
send_menu: {
  phrase_delivery: "Заберите, пожалуйста, меню",
  video_url_delivery: "",
  phrase_pickup: "Положите меню для стола",
  // ...
}
```

На вкладке `send_menu` в Э4:
- Поле «Фраза на станции выдачи» (PhraseInput) — default: `"Положите меню для стола"` (без `{N}`)
- Убрать hint/подсказку о переменной `{N}`, если была
- Фраза полностью статическая — плагину и роботу не нужно обрабатывать шаблонные переменные

**Обоснование**: Руслан (18.02): «Давайте просто оставим "положить меню для стола". Всё.»

---

### N11. [П-5] Удалить вкладку «Маркетинг» из Э4

**Файл**: `app/settings/page.tsx` (экран Э4 — Настройки сценариев)

### УДАЛИТЬ

Полностью удалить вкладку «Маркетинг» (`marketing`) из навигации по вкладкам на экране Э4:

**БЫЛО** — 5 вкладок:
```tsx
<Tabs defaultValue="send_menu">
  <TabsList>
    <TabsTrigger value="send_menu">Доставка меню</TabsTrigger>
    <TabsTrigger value="send_dish">Доставка блюд</TabsTrigger>
    <TabsTrigger value="cleanup">Уборка посуды</TabsTrigger>
    <TabsTrigger value="qr_payment">Оплата по QR</TabsTrigger>
    <TabsTrigger value="marketing">Маркетинг</TabsTrigger>
  </TabsList>
  {/* ... TabsContent для каждой вкладки ... */}
</Tabs>
```

**СТАЛО** — 4 вкладки:
```tsx
<Tabs defaultValue="send_menu">
  <TabsList>
    <TabsTrigger value="send_menu">Доставка меню</TabsTrigger>
    <TabsTrigger value="send_dish">Доставка блюд</TabsTrigger>
    <TabsTrigger value="cleanup">Уборка посуды</TabsTrigger>
    <TabsTrigger value="qr_payment">Оплата по QR</TabsTrigger>
  </TabsList>
  {/* ... TabsContent — БЕЗ marketing ... */}
</Tabs>
```

Удалить полностью:
1. `<TabsTrigger value="marketing">` из TabsList
2. `<TabsContent value="marketing">` — весь блок контента вкладки
3. Всё содержимое вкладки Marketing:
   - MultiSelect роботов (`robot_ids[]`)
   - Checkbox `auto_start_on_idle` («Автозапуск при простое»)
   - UiInput `idle_timeout_sec` (число 0–300, добавлен v1.10 M1)
   - Checkbox `start_by_timer`
   - Time inputs `time_start` / `time_end`
   - Info-блок (UiAlert blue) о взаимодействии `after_action` и маркетинга (добавлен v1.10 M3)

**Обоснование**: Маркетинг управляется **исключительно** через `after_action` per-robot на Б5. Вкладка «Маркетинг» полностью нерелевантна.

---

### N12. [П-5] Обновить TypeScript интерфейс ScenarioSettings

**Файл**: где определены типы mock-данных (вероятно `types.ts` или верх `app/settings/page.tsx`)

### ОБНОВИТЬ

**БЫЛО**:
```tsx
interface MarketingSettings {
  robot_ids: string[];
  auto_start_on_idle: boolean;
  idle_timeout_sec: number;  // v1.10 M2
  start_by_timer: boolean;
  time_start: string | null;
  time_end: string | null;
}

interface ScenarioSettings {
  send_menu: SendMenuSettings;
  send_dish: SendDishSettings;
  cleanup: CleanupSettings;
  qr_payment: QrPaymentSettings;
  marketing: MarketingSettings;
}
```

**СТАЛО**:
```tsx
// MarketingSettings — УДАЛЁН (v1.11 N12, П-5)
// Маркетинг управляется через after_action per-robot (Б5)

interface ScenarioSettings {
  send_menu: SendMenuSettings;
  send_dish: SendDishSettings;
  cleanup: CleanupSettings;
  qr_payment: QrPaymentSettings;
  // marketing — УДАЛЁН (v1.11 N12, П-5)
}
```

Также удалить `marketing` из mock-данных `ScenarioSettings`:

**БЫЛО**:
```tsx
const mockSettings: ScenarioSettings = {
  send_menu: { /* ... */ },
  send_dish: { /* ... */ },
  cleanup: { /* ... */ },
  qr_payment: { /* ... */ },
  marketing: {
    robot_ids: [],
    auto_start_on_idle: false,
    idle_timeout_sec: 30,
    start_by_timer: false,
    time_start: null,
    time_end: null,
  },
};
```

**СТАЛО**:
```tsx
const mockSettings: ScenarioSettings = {
  send_menu: { /* ... */ },
  send_dish: { /* ... */ },
  cleanup: { /* ... */ },
  qr_payment: { /* ... */ },
  // marketing — УДАЛЁН (v1.11 N12, П-5)
};
```

---

### N13. [П-5 + П-6] Обновить tooltip `after_action` на Э1 (Б5)

**Файл**: `app/robots/page.tsx` (экран Э1 — Список роботов)

### ОБНОВИТЬ

Обновить tooltip для столбца «Действие после задачи» (`after_action`):

**БЫЛО**:
```
«Поведение робота после завершения задачи: ожидает новую задачу или переходит в маркетинговый круиз»
```

**СТАЛО**:
```
«Поведение робота после завершения задачи: ожидает новую задачу или переходит в маркетинговый круиз. При значении "Маркетинг" — робот на постоянной основе запускает круиз сразу после завершения любой задачи, без таймеров и расписания. NE автоматически снимает робота с маркетинга при нехватке свободных роботов»
```

**Обоснование**: П-5 (маркетинг только через after_action) + П-6 (NE автоматически перераспределяет роботов).

---

## Порядок элементов на Э4 (после патча)

```
1. Subheader: «Настройки сценариев»                               [существующий]
2. 4 вкладки: send_menu, send_dish, cleanup, qr_payment           [обновлён — N11: было 5]
3. Содержимое активной вкладки                                     [существующий]
4. Sticky footer: Сохранить / Сбросить                             [существующий]
```

---

## Чек-лист применения патча

### П-1: Credentials

- [ ] N1: NeConnectionCard удалена с Э0
- [ ] N1: Нет карточки статуса подключения в верхней части Э0
- [ ] N2: NeCredentialsModal удалена (модалка и файл)
- [ ] N2: Нет модалки ввода `client_id` / `api_secret`
- [ ] N3: Таблица ресторанов **всегда** кликабельна, без `opacity-50`
- [ ] N4: Toast #14 удалён
- [ ] N4: Toast #15 удалён
- [ ] N4: Toast #16 удалён

### П-2: Ошибка 404

- [ ] N5: Текст Alert при 404: «Робот не найден. Проверьте ID робота. Если данные верны — обратитесь в Next Era для уточнения»
- [ ] N5: Старый текст «Робот не найден в системе PUDU...» больше не отображается

### П-3: Маппинг «Точки → Столы»

- [ ] N6: SegmentedControl удалён с Э3
- [ ] N6: Нет переключателя направления маппинга
- [ ] N7: Каждая строка таблицы = точка робота (font-mono, read-only)
- [ ] N7: Каждая точка имеет ровно один UiSelect для стола
- [ ] N7: Placeholder UiSelect: «— не привязана»
- [ ] N7: Несколько точек могут выбрать один стол (N:1)
- [ ] N7: Ручные столы в UiSelect помечены `(ручной)`
- [ ] N7: Кнопок «+ Точку» и «x» нет
- [ ] N8a: Фильтр по залу фильтрует **опции** UiSelect, а не строки
- [ ] N8b: Предупреждение: «N точек не имеют привязки к столам iiko»
- [ ] N8c: Секция «Ручные столы» с чипами и удалением
- [ ] N9: Mock-данные: 10 записей `{ point_id, table_id }`, 7 привязаны, 3 без

### П-4: phrase_pickup

- [ ] N10: Mock `phrase_pickup` = `"Положите меню для стола"` (без `{N}`)
- [ ] N10: Нет упоминаний переменной `{N}` в UI вкладки send_menu

### П-5: Вкладка «Маркетинг»

- [ ] N11: Вкладка «Маркетинг» удалена из Tabs на Э4
- [ ] N11: Tabs содержит ровно 4 вкладки: send_menu, send_dish, cleanup, qr_payment
- [ ] N11: Нет TabsContent для `marketing`
- [ ] N12: Интерфейс `MarketingSettings` удалён
- [ ] N12: Поле `marketing` удалено из `ScenarioSettings`
- [ ] N12: Объект `marketing` удалён из mock-данных

### П-6: Tooltip after_action

- [ ] N13: Tooltip столбца `after_action` обновлён — содержит описание обоих режимов
- [ ] N13: Tooltip упоминает автоматическое перераспределение NE

---

## Перекрёстные ссылки

| Документ       | Раздел                | Что связано                                                |
| -------------- | --------------------- | ---------------------------------------------------------- |
| SPEC-002 v1.19 | 2.5                   | Аутентификация — системные константы                       |
| SPEC-002 v1.19 | 2.6.13, 2.6.14        | Endpoints credentials [REMOVED]                            |
| SPEC-002 v1.19 | 2.8.6                 | Таблица `pudu_ne_credential` — системная                   |
| SPEC-002 v1.19 | 5.3, 5.5              | Ошибка 404 — единая формулировка                           |
| SPEC-002 v1.19 | 6.1–6.5               | Маппинг «Точки → Столы»: таблица, действия, ошибки         |
| SPEC-002 v1.19 | 7.2                   | phrase_pickup send_menu — статическая фраза без `{N}`      |
| SPEC-002 v1.19 | 7.1, 7.6, 7.6a        | Удаление вкладки «Маркетинг», удаление бизнес-правил R1–R6 |
| SPEC-002 v1.19 | 4 (Б5)                | Tooltip after_action + бизнес-правило перераспределения NE |
| SPEC-002 v1.19 | 2.6.10, 2.6.11, 2.8.5 | JSON-контракты — удалён объект `marketing`                 |
| Правки         | П-1–П-6               | `2026-02-26-правки-SPEC-002-по-встрече-18-02.md`           |
| Стенограмма    | 03:21–04:43           | Решение по credentials (Олег NE, Кирилл)                   |
| Стенограмма    | 10:54–13:46           | Решение по ошибке 404 (Олег NE, Руслан)                    |
| Стенограмма    | 19:24–19:35           | Решение по направлению маппинга (Руслан)                   |
| Стенограмма    | 21:54–21:57           | Решение по phrase_pickup без `{N}` (Руслан)                |
| Стенограмма    | 29:00–40:05           | Решение по удалению вкладки «Маркетинг» (Руслан, Кирилл)   |
| Стенограмма    | 39:38–40:05           | Решение по перераспределению NE (Руслан)                   |
