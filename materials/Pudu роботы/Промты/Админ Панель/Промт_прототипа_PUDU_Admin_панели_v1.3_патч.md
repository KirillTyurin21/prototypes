# Промт-патч v1.3: Панель администрирования роботов PUDU в iikoWeb

---
**Версия**: 1.3
**Дата**: 2026-02-13
**Автор**: Кирилл Тюрин (системный аналитик)
**Статус**: [PENDING]
**Артефакт**: Д3-патч (Промт-патч для обновления прототипа iikoWeb)
**Базовый документ**: Промт_прототипа_PUDU_Admin_панели_v1.2_патч.md (v1.2, 2026-02-13)
**Источники**: Тестирование прототипа v1.2, обратная связь по маппингу
---

## Назначение

Этот документ — **дельта-патч** к промту v1.2. Он описывает **только изменения**, которые необходимо внести в прототип Admin Panel по результатам тестирования прототипа v1.2.

**Инструкция по применению**: сначала примени базовый промт `Промт_прототипа_PUDU_Admin_панели.md` (v1.1), затем патч v1.2 `Промт_прототипа_PUDU_Admin_панели_v1.2_патч.md`, и затем этот патч v1.3 — последовательно. Каждый раздел указывает, что **удалить**, что **добавить** и что **изменить**.

---

## Перечень изменений v1.3

| #   | Изменение                                        | Область  | Причина                                                                                                             |
| --- | ------------------------------------------------ | -------- | ------------------------------------------------------------------------------------------------------------------- |
| Е1  | Названия точек — технические идентификаторы NE   | Э3, Mock | Реальные точки из системы PUDU имеют нечитаемые технические названия (серийные номера), а не человекочитаемые имена |
| Е2  | Эксклюзивное назначение точек (1 точка = 1 стол) | Э3       | Одна точка может быть привязана строго к одному столу. При перепривязке — автоматический перенос с уведомлением     |
| Е3  | Полный пул точек в каждом Select                 | Э3       | Каждый Select должен показывать все доступные (незанятые) точки + текущую выбранную, а не только «свои» точки       |
| Е4  | Удаление столбца «Действия» из таблицы маппинга  | Э3       | Кнопка «Тест» не обеспечена функционалом со стороны NE. Кнопка «+ Точку» перемещена в ячейку «Привязанные точки»    |
| Е5  | Обновление mock-данных точек                     | Mock     | Названия точек заменены на технические идентификаторы. Маппинг обновлён для демонстрации эксклюзивности             |

---

## Е1. Названия точек — технические идентификаторы NE

> **Контекст**: При тестировании прототипа v1.2 обнаружено, что названия точек в mock-данных были человекочитаемые («Стол у окна», «Стол 2» и т.д.). В реальности система PUDU/NE генерирует для точек **технические идентификаторы** (серийные номера вида «234234SF», «SF234234S»), которые нечитаемы для человека. Прототип должен отражать реальное поведение.

### ИЗМЕНИТЬ mock-данные точек

**Было (v1.2):**

```typescript
const mockPoints: RobotPoint[] = [
  { point_id: "pt-001", point_name: "Стол у окна" },
  { point_id: "pt-002", point_name: "Стол 2" },
  { point_id: "pt-003", point_name: "Стол 3 (VIP)" },
  { point_id: "pt-004", point_name: "Стол 4 (бар)" },
  { point_id: "pt-005", point_name: "Стол 5" },
  { point_id: "pt-006", point_name: "Стол 6 (терраса)" }
];
```

**Стало (v1.3):**

```typescript
const mockPoints: RobotPoint[] = [
  { point_id: "pt-001", point_name: "SF234201A" },
  { point_id: "pt-002", point_name: "SF234202B" },
  { point_id: "pt-003", point_name: "SF234203C" },
  { point_id: "pt-004", point_name: "SF234204D" },
  { point_id: "pt-005", point_name: "SF234205E" },
  { point_id: "pt-006", point_name: "SF234206F" },
  { point_id: "pt-007", point_name: "SF234207G" },
  { point_id: "pt-008", point_name: "SF234208H" },
  { point_id: "pt-009", point_name: "SF234209I" },
  { point_id: "pt-010", point_name: "SF234210J" }
];
```

**Ключевые отличия от v1.2:**
- **10 точек** вместо 6 — больше точек, чем столов (реалистичный сценарий)
- Названия — **нечитаемые технические идентификаторы** формата серийных номеров NE
- Стилизация названий точек в таблице: `font-mono text-sm text-gray-600` (моноширинный шрифт для технических ID)

### ИЗМЕНИТЬ стилизацию Select точки

В каждом Select для привязки точки отображение опций:

| Элемент                  | Стилизация                                                       |
| ------------------------ | ---------------------------------------------------------------- |
| Выбранная точка          | `font-mono text-sm text-gray-900`                                |
| Опция в dropdown         | `font-mono text-sm text-gray-700`                                |
| Опция «Не назначена»     | `italic text-sm text-gray-400` (без font-mono)                   |
| Занятая точка в dropdown | `font-mono text-sm text-gray-400` + пометка `(Стол №{N})` italic |

---

## Е2. Эксклюзивное назначение точек (1 точка = 1 стол)

> **Контекст**: В v1.2 не было ограничения — одна и та же точка могла быть выбрана для нескольких столов одновременно. В реальности каждая физическая точка робота может быть привязана **строго к одному столу**. При попытке назначить занятую точку другому столу, привязка автоматически переносится.

### ДОБАВИТЬ: Логика эксклюзивного назначения

**Правила:**

1. **Select показывает полный пул**: каждый Select отображает **все** точки из `mockPoints` — как свободные, так и занятые другими столами.
2. **Свободные точки**: отображаются нормальным шрифтом, доступны для выбора.
3. **Занятые точки**: отображаются приглушённым цветом с пометкой, к какому столу привязаны. Например: `SF234201A (Стол №3)`. Доступны для выбора (перепривязка).
4. **При выборе занятой точки**: привязка **автоматически снимается** со старого стола и переносится на новый. Отображается Toast-уведомление.
5. **Уже выбранная текущим столом**: не отображается повторно в dropdown (если у стола уже есть эта точка в другом select — она скрыта).

**Toast при перепривязке:**

```
variant: "warning" (border-orange)
title: "Точка перенесена"
description: "Точка {point_name} перенесена со стола {old_table_name} на стол {new_table_name}"
duration: 4 сек
```

**Пример интерактивности прототипа:**

Предустановленный маппинг (v1.3):

```typescript
const mockMapping: TableMapping[] = [
  { table_id: "tbl-001", points: [mockPoints[0]] },                  // Стол №1 → SF234201A
  { table_id: "tbl-002", points: [mockPoints[1]] },                  // Стол №2 → SF234202B
  { table_id: "tbl-003", points: [mockPoints[2], mockPoints[3]] },   // Стол №3 → SF234203C + SF234204D (1:N)
  { table_id: "tbl-004", points: [mockPoints[4]] },                  // Стол №4 → SF234205E
  { table_id: "tbl-005", points: [] },                                // Стол №5 → НЕ ЗАМАПЛЕН
  { table_id: "tbl-006", points: [mockPoints[5]] },                  // Стол №6 → SF234206F
  { table_id: "tbl-007", points: [] },                                // Стол №7 → НЕ ЗАМАПЛЕН
  { table_id: "tbl-008", points: [] }                                 // Стол №8 → НЕ ЗАМАПЛЕН
];
// Свободные точки: SF234207G, SF234208H, SF234209I, SF234210J (+ незамапленные столы)
```

**Сценарий для демо:**
1. Пользователь видит Стол №5 без привязки — статус серый `circle`.
2. В Select для Стола №5 видит:
   - Свободные: `SF234207G`, `SF234208H`, `SF234209I`, `SF234210J` — обычным шрифтом
   - Занятые: `SF234201A (Стол №1)`, `SF234202B (Стол №2)`, `SF234203C (Стол №3)`, `SF234204D (Стол №3)`, `SF234205E (Стол №4)`, `SF234206F (Стол №6)` — приглушённым
3. Пользователь выбирает `SF234201A` (занятую Столом №1).
4. Привязка `SF234201A` **снимается** со Стола №1, Стол №1 становится «не замаплен» (серый `circle`).
5. `SF234201A` назначается Столу №5 — статус зелёный `check-circle-2`.
6. Toast (warning): «Точка SF234201A перенесена со стола Стол №1 на стол Стол №5» (4 сек).

---

## Е3. Полный пул точек в каждом Select

> **Контекст**: В v1.2 каждый Select показывал ограниченный набор точек (фактически — только «свою» точку). Теперь Select должен показывать **все** точки из пула.

### ИЗМЕНИТЬ: логика формирования списка опций Select

**Алгоритм для каждого Select в строке стола:**

```
1. Взять полный массив mockPoints (10 точек)
2. Исключить точки, уже назначенные ЭТОМУ ЖЕ столу в ДРУГИХ select'ах (избежать дублей)
3. Для оставшихся:
   a. Если точка свободна (не назначена ни одному столу) → обычное отображение
   b. Если точка занята другим столом → приглушённое отображение + "(Стол №{N})"
   c. Если точка = текущее значение этого select → показать как выбранную (сверху)
4. Первая опция: "Не назначена" (italic, gray-400)
```

**Структура dropdown:**

```
┌──────────────────────────────────────┐
│ Не назначена                    (italic, gray) │
│──────────────────────────────────────│
│ ● SF234207G                     (свободная)     │
│   SF234208H                     (свободная)     │
│   SF234209I                     (свободная)     │
│   SF234210J                     (свободная)     │
│──────────────────────────────────────│
│   SF234201A (Стол №1)           (занятая, gray) │
│   SF234202B (Стол №2)           (занятая, gray) │
│   SF234203C (Стол №3)           (занятая, gray) │
│   SF234204D (Стол №3)           (занятая, gray) │
│   SF234205E (Стол №4)           (занятая, gray) │
│   SF234206F (Стол №6)           (занятая, gray) │
└──────────────────────────────────────┘
```

**Разделитель**: горизонтальная линия (`border-t border-gray-200`) между свободными и занятыми точками.

---

## Е4. Удаление столбца «Действия» из таблицы маппинга

> **Контекст**: Кнопка «Тест» не обеспечена функционалом — endpoint `POST /api/pudu/tasks/test` убран из MVP. Столбец «Действия» с кнопками «Тест» и «+ Точку» удалён из таблицы. Кнопка «+ Точку» перемещена внутрь ячейки «Привязанные точки».

### УДАЛИТЬ из таблицы маппинга Э3

1. **Столбец #4 «Действия»** — удалить полностью из обоих вариантов маппинга (A и B).
2. **Кнопка «Тест»** — удалить полностью (все упоминания).

### ИЗМЕНИТЬ таблицу маппинга

**Обновлённая таблица (Вариант A: Столы → Точки):**

| #   | Столбец           | Описание                                         | Стилизация                                                                                                    |
| --- | ----------------- | ------------------------------------------------ | ------------------------------------------------------------------------------------------------------------- |
| 1   | Стол iiko         | Название стола + section_name                    | `text-sm text-gray-900`, секция `text-xs text-gray-500`                                                       |
| 2   | Привязанные точки | 1–N select'ов с точками + кнопка «+ Точку» внизу | Каждый select — строка. Кнопка `x` у каждого для удаления. Точки `font-mono`. Внизу списка: «+ Точку» (ghost) |
| 3   | Статус            | Иконка                                           | `check-circle-2 text-green-600` замаплен / `circle text-gray-300` не замаплен                                 |

**Столбец «Привязанные точки» — layout ячейки:**

```
┌────────────────────────────────────────────────────────┐
│ [Select: SF234201A ▼]                           [× ]   │
│ [Select: SF234207G ▼]                           [× ]   │
│                                                        │
│ [+ Точку]  (ghost, sm, иконка plus, text-blue-600)     │
└────────────────────────────────────────────────────────┘
```

- Каждый select: полная ширина ячейки, `font-mono` для выбранного значения
- Кнопка `x` (icon button, ghost, sm, `text-gray-400 hover:text-red-500`) — справа от каждого select
- Кнопка «+ Точку» — **под** списком select'ов, выровнена влево, `text-blue-600`
- Если у стола 0 точек — отображается только кнопка «+ Точку»

**Обновлённая таблица (Вариант B: Точки → Столы):**

| #   | Столбец          | Описание                       | Стилизация                                               |
| --- | ---------------- | ------------------------------ | -------------------------------------------------------- |
| 1   | Точка робота     | Название точки (read-only, NE) | `font-mono text-sm text-gray-900`                        |
| 2   | Привязанный стол | Select со столами iiko         | Select. Опция «Не назначена» (`italic text-gray-400`)    |
| 3   | Статус           | Иконка                         | `check-circle-2 text-green-600` / `circle text-gray-300` |

> **Примечание**: В варианте B столбец «Действия» содержал только кнопку «Тест» — удалён полностью. Кнопка «+ Точку» не применима к варианту B (строки = точки, каждая привязывается к одному столу).

### УДАЛИТЬ: действие #7 «Клик Тест» из таблицы действий

В разделе действий экрана Э3 (v1.2, C3 → Таблица действий): удалить строку «Клик «Тест» → Отправить тестовую команду → POST /api/pudu/tasks/test».

### УДАЛИТЬ: ошибки тестовой команды

Из раздела ошибок маппинга (v1.2, C3) удалить:
- «Робот offline → Toast: Робот не в сети»
- «Ошибка тестовой команды → Toast: Робот не смог выполнить команду»

### ДОБАВИТЬ: Toast для перепривязки

| #   | Экран | Триггер                            | Текст Title        | Описание                                                                 | Вариант | Длительность |
| --- | ----- | ---------------------------------- | ------------------ | ------------------------------------------------------------------------ | ------- | ------------ |
| 9   | Э3    | Выбор точки, занятой другим столом | «Точка перенесена» | «Точка {point_name} перенесена со стола {old_table} на стол {new_table}» | warning | 4 сек        |

---

## Е5. Обновление mock-данных

### ИЗМЕНИТЬ: mockPoints (полная замена)

```typescript
// v1.3: 10 точек с техническими названиями NE (серийные номера PUDU)
const mockPoints: RobotPoint[] = [
  { point_id: "pt-001", point_name: "SF234201A" },
  { point_id: "pt-002", point_name: "SF234202B" },
  { point_id: "pt-003", point_name: "SF234203C" },
  { point_id: "pt-004", point_name: "SF234204D" },
  { point_id: "pt-005", point_name: "SF234205E" },
  { point_id: "pt-006", point_name: "SF234206F" },
  { point_id: "pt-007", point_name: "SF234207G" },
  { point_id: "pt-008", point_name: "SF234208H" },
  { point_id: "pt-009", point_name: "SF234209I" },
  { point_id: "pt-010", point_name: "SF234210J" }
];
```

### ИЗМЕНИТЬ: mockMapping (полная замена)

```typescript
// v1.3: 5 из 8 столов замаплены, 3 свободных; 4 точки не назначены
const mockMapping: TableMapping[] = [
  { table_id: "tbl-001", points: [mockPoints[0]] },                  // Стол №1 → SF234201A
  { table_id: "tbl-002", points: [mockPoints[1]] },                  // Стол №2 → SF234202B
  { table_id: "tbl-003", points: [mockPoints[2], mockPoints[3]] },   // Стол №3 → SF234203C + SF234204D (1:N)
  { table_id: "tbl-004", points: [mockPoints[4]] },                  // Стол №4 → SF234205E
  { table_id: "tbl-005", points: [] },                                // Стол №5 → НЕ ЗАМАПЛЕН
  { table_id: "tbl-006", points: [mockPoints[5]] },                  // Стол №6 → SF234206F
  { table_id: "tbl-007", points: [] },                                // Стол №7 → НЕ ЗАМАПЛЕН
  { table_id: "tbl-008", points: [] }                                 // Стол №8 → НЕ ЗАМАПЛЕН
];
// Назначенные точки: SF234201A...SF234206F (6 шт)
// Свободные точки: SF234207G, SF234208H, SF234209I, SF234210J (4 шт)
// Незамапленные столы: Стол №5, Стол №7, Стол №8 (3 шт)
```

---

## Обновлённый чеклист Э3

Было (v1.2):
```
- [ ] Маппинг универсальный — без Select робота (один на всё заведение)
- [ ] Таблица маппинга: Стол, Точки (select), Статус, Действия (без столбца «Тип точки»)
- [ ] Подсказка (info-блок): маппинг един для заведения, настройка инженером NE (З-09)
- [ ] Названия точек read-only — как есть от NE
- [ ] 1:N маппинг: несколько точек к одному столу (кнопка «+ Точку»)
- [ ] Два варианта маппинга (З-10): «Столы → Точки» (основной) и «Точки → Столы» (альтернативный)
```

Стало (v1.3):
```
- [ ] Маппинг универсальный — без Select робота (один на всё заведение)
- [ ] Таблица маппинга: 3 столбца — Стол iiko, Привязанные точки (+ кнопка «+ Точку» внутри), Статус (столбец «Действия» убран в v1.3)
- [ ] Подсказка (info-блок): маппинг един для заведения, настройка инженером NE (З-09)
- [ ] Названия точек read-only — технические идентификаторы NE (font-mono, нечитаемые серийные номера)
- [ ] 1:N маппинг: несколько точек к одному столу (кнопка «+ Точку» внутри ячейки)
- [ ] Эксклюзивность: одна точка = один стол. При перепривязке — автоперенос + Toast warning
- [ ] Select показывает полный пул точек: свободные (обычный шрифт) + занятые (gray + «Стол №N»)
- [ ] Разделитель в dropdown между свободными и занятыми точками
- [ ] Mock: 10 точек с техническими ID, 8 столов, 3 незамаплены, 4 точки свободны
- [ ] Два варианта маппинга (З-10): «Столы → Точки» (основной) и «Точки → Столы» (альтернативный)
- [ ] Вариант B (Точки → Столы): столбец «Действия» тоже убран
```

---

## Общий чеклист патча v1.3

- [ ] Mock-данные точек: 10 точек с техническими ID (SF234201A...SF234210J)
- [ ] Mock-маппинг: 5 столов замаплены, 3 нет; 4 точки свободны
- [ ] Стилизация point_name: `font-mono text-sm` везде
- [ ] Логика эксклюзивности точек работает (перенос + Toast)
- [ ] Select показывает полный пул (свободные + занятые с пометкой)
- [ ] Разделитель в dropdown между свободными и занятыми
- [ ] Столбец «Действия» убран из обоих вариантов (A и B)
- [ ] Кнопка «Тест» полностью удалена
- [ ] Кнопка «+ Точку» находится внутри ячейки «Привязанные точки»
- [ ] Все тексты на русском языке
- [ ] Toast-уведомления: добавлен #9 «Точка перенесена» (warning, 4 сек)

---

## История изменений

| Версия | Дата       | Автор        | Изменения                                                                                                    |
| ------ | ---------- | ------------ | ------------------------------------------------------------------------------------------------------------ |
| 1.0    | 2026-02-11 | Кирилл Тюрин | Первоначальная версия промта прототипа Admin Panel                                                           |
| 1.1    | 2026-02-11 | Кирилл Тюрин | Минорные правки                                                                                              |
| 1.2    | 2026-02-13 | Кирилл Тюрин | Патч по итогам встречи 11.02: C1–C10 (убрать Регион/SecretKey, универсальный маппинг, система фраз и т.д.)   |
| 1.3    | 2026-02-13 | Кирилл Тюрин | Патч по результатам тестирования: Е1–Е5 (технические ID точек, эксклюзивное назначение, удаление «Действия») |
