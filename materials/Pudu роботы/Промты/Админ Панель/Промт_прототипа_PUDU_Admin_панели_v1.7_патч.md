# Промт-патч v1.7: Панель администрирования роботов PUDU в iikoWeb

---
**Версия**: 1.7
**Дата**: 2026-02-17
**Автор**: Кирилл Тюрин (системный аналитик)
**Статус**: [PENDING]
**Артефакт**: Д3-патч (Промт-патч для обновления прототипа iikoWeb)
**Базовый документ**: Промт_прототипа_PUDU_Admin_панели_v1.6_патч.md (v1.6, 2026-02-17)
**Источники**: SPEC-002 v1.14 (раздел 7.6, 2.6.10, 2.6.11, 2.8.5, 2.8.7, 2.8.8); стенограмма 11.02 (Кирилл: «два робота только занимались маркетингом»; Рустам NE: «Да, будем выбирать», упоминание ресторанов с 15 роботами)
**Scope**: Замена Single Select на Multi-Select для выбора роботов маркетинга (Э4, вкладка marketing)
---

## Назначение

Этот документ — **дельта-патч** к промту v1.6. Он описывает одну логическую группу изменений:

**J1–J5**: Замена UiSelect (один робот) на **UiMultiSelect** (несколько роботов) для маркетингового сценария. Администратор может назначить любое количество роботов на маркетинговый круиз.

**Обоснование**: На встрече 11.02 Кирилл описал сценарий: *«А если роботов действительно очень много, и надо, чтобы два робота только занимались маркетингом, чтобы это эстетично выглядело»*. Рустам (NE) подтвердил необходимость выбора (*«Да, будем выбирать»*) и упомянул рестораны с 15 роботами. Single Select не покрывает сценарий с несколькими роботами на маркетинге.

**Инструкция по применению**: сначала примени базовый промт `Промт_прототипа_PUDU_Admin_панели.md` (v1.1), затем патчи v1.2, v1.3, v1.4, v1.5, v1.6 и затем этот патч v1.7 — последовательно.

**Ключевые изменения v1.7:**
- Поле «Робот для маркетинга» (UiSelect, один) → «Роботы для маркетинга» (**UiMultiSelect**, несколько)
- TypeScript: `marketing.robot_id: string` → `marketing.robot_ids: string[]`
- Mock-данные: `robot_id: "PD2024060001"` → `robot_ids: ["PD2024060001"]`
- Tooltip обновлён: «Какие роботы используются для маркетингового круиза. Можно выбрать несколько»
- UI: чипы (badges) выбранных роботов с кнопкой «×» для удаления

---

## Совместимость с предыдущими патчами

| Патч           | Совместимость | Примечание                                     |
| -------------- | ------------- | ---------------------------------------------- |
| v1.1 (базовый) | Требуется     | Экран Э4 с вкладкой marketing, интерфейс типов |
| v1.2 (C1–C10)  | Требуется     | —                                              |
| v1.3 (E1–E5)   | Требуется     | —                                              |
| v1.4 (F1–F13)  | Требуется     | Tooltips и двухуровневая навигация             |
| v1.5 (G1–G11)  | Требуется     | —                                              |
| v1.6 (H1–H6)   | Требуется     | Рефакторинг cleanup (не затрагивает marketing) |

---

## Перечень изменений v1.7

| #      | Изменение                                       | Область | Причина                                      |
| ------ | ----------------------------------------------- | ------- | -------------------------------------------- |
| **J1** | TypeScript: `robot_id` → `robot_ids[]`          | Э4 (Б3) | SPEC-002 v1.14: массив роботов вместо одного |
| **J2** | Mock-данные: массив вместо строки               | Э4 (Б3) | Синхронизация mock с обновлённым типом       |
| **J3** | UI: UiSelect → Multi-Select с чипами            | Э4 (Б3) | Поддержка выбора нескольких роботов          |
| **J4** | Таблица полей: обновление строки #1             | Э4 (Б3) | Label, контрол, подсказка, валидация         |
| **J5** | Toast: предупреждение при удалении всех роботов | Э4 (Б3) | UX: информирование о пустом списке           |

---

## J1. TypeScript: `robot_id` → `robot_ids[]`

### Экран Э4 (Б3), файл `app/settings/page.tsx`

### ИЗМЕНИТЬ в интерфейсе `ScenarioSettings`:

**Было (v1.1):**
```typescript
  marketing: {
    robot_id: string;
    auto_cruise_on_idle: boolean;
    timer_enabled: boolean;
    timer_start: string;         // "HH:MM"
    timer_end: string;           // "HH:MM"
  };
```

**Стало (v1.7):**
```typescript
  marketing: {
    robot_ids: string[];           // массив ID роботов для маркетинга (пустой = не выбраны)
    auto_cruise_on_idle: boolean;
    timer_enabled: boolean;
    timer_start: string;           // "HH:MM"
    timer_end: string;             // "HH:MM"
  };
```

**Причина**: SPEC-002 v1.14 — массив `robot_ids: string[]` вместо `robot_id: string | null`. Пустой массив `[]` эквивалентен прежнему `null` (ни один робот не выбран).

---

## J2. Mock-данные: массив вместо строки

### ИЗМЕНИТЬ `mockSettings.marketing`:

**Было (v1.1):**
```typescript
  marketing: {
    robot_id: "PD2024060001",
    auto_cruise_on_idle: false,
    timer_enabled: false,
    timer_start: "11:00",
    timer_end: "14:00"
  },
```

**Стало (v1.7):**
```typescript
  marketing: {
    robot_ids: ["PD2024060001"],    // BellaBot-01 назначен на маркетинг
    auto_cruise_on_idle: false,
    timer_enabled: false,
    timer_start: "11:00",
    timer_end: "14:00"
  },
```

**Примечание**: В mock-данных один робот предвыбран для демонстрации. При демонстрации администратор может добавить второй робот (Ketty-02) через Multi-Select.

---

## J3. UI: UiSelect → Multi-Select с чипами

### ИЗМЕНИТЬ: рендер поля #1 вкладки Marketing, файл `components/settings/tab-marketing.tsx`

**Было (v1.1):**
```tsx
{/* Поле 1: Робот для маркетинга */}
<div className="space-y-2">
  <Label>Робот для маркетинга</Label>
  <Select
    value={settings.marketing.robot_id}
    onValueChange={(value) => updateSettings('marketing', { robot_id: value })}
  >
    <SelectTrigger>
      <SelectValue placeholder="Выберите робота" />
    </SelectTrigger>
    <SelectContent>
      {robots.map(robot => (
        <SelectItem key={robot.id} value={robot.id}>
          {robot.name} ({robot.id})
        </SelectItem>
      ))}
    </SelectContent>
  </Select>
  <p className="text-xs text-gray-500">
    Какой робот используется для маркетингового круиза
  </p>
</div>
```

**Стало (v1.7):**
```tsx
{/* Поле 1: Роботы для маркетинга (Multi-Select) */}
<div className="space-y-2">
  <Label>Роботы для маркетинга</Label>

  {/* Чипы выбранных роботов */}
  {settings.marketing.robot_ids.length > 0 && (
    <div className="flex flex-wrap gap-2 mb-2">
      {settings.marketing.robot_ids.map(id => {
        const robot = robots.find(r => r.id === id);
        return (
          <Badge
            key={id}
            variant="secondary"
            className="px-2 py-1 text-xs font-normal bg-blue-50 text-blue-700
                       border border-blue-200 flex items-center gap-1"
          >
            {robot?.name ?? id}
            <button
              onClick={() => {
                const newIds = settings.marketing.robot_ids.filter(rid => rid !== id);
                updateSettings('marketing', { robot_ids: newIds });
              }}
              className="ml-1 hover:text-blue-900 transition-colors"
              aria-label={`Убрать ${robot?.name ?? id} из маркетинга`}
            >
              <X className="h-3 w-3" />
            </button>
          </Badge>
        );
      })}
    </div>
  )}

  {/* Select для добавления робота */}
  <Select
    value=""
    onValueChange={(value) => {
      if (!settings.marketing.robot_ids.includes(value)) {
        updateSettings('marketing', {
          robot_ids: [...settings.marketing.robot_ids, value]
        });
      }
    }}
  >
    <SelectTrigger>
      <SelectValue placeholder={
        settings.marketing.robot_ids.length === 0
          ? "Выберите роботов для маркетинга"
          : "Добавить ещё робота..."
      } />
    </SelectTrigger>
    <SelectContent>
      {robots
        .filter(robot => !settings.marketing.robot_ids.includes(robot.id))
        .map(robot => (
          <SelectItem key={robot.id} value={robot.id}>
            {robot.name} ({robot.id})
          </SelectItem>
        ))}
      {robots.filter(robot => !settings.marketing.robot_ids.includes(robot.id)).length === 0 && (
        <div className="px-3 py-2 text-xs text-gray-400 text-center">
          Все роботы добавлены
        </div>
      )}
    </SelectContent>
  </Select>

  <p className="text-xs text-gray-500">
    Какие роботы используются для маркетингового круиза. Можно выбрать несколько
  </p>
</div>
```

**Поведение Multi-Select:**

| Шаг | Действие                    | Реакция UI                                                                              |
| --- | --------------------------- | --------------------------------------------------------------------------------------- |
| 1   | Клик на SelectTrigger       | Дропдаун: список роботов **без уже выбранных**                                          |
| 2   | Выбор робота                | Робот добавлен в `robot_ids[]`, появляется чип (Badge) над Select. Дропдаун закрывается |
| 3   | Клик «×» на чипе            | Робот удалён из `robot_ids[]`, чип исчезает. Placeholder Select обновляется             |
| 4   | Все роботы выбраны          | Дропдаун показывает «Все роботы добавлены» (серый текст)                                |
| 5   | Все роботы удалены из чипов | Placeholder: «Выберите роботов для маркетинга». Чипы скрыты                             |

**Стилизация чипов:**
- Бейдж: `bg-blue-50 text-blue-700 border border-blue-200` (согласовано с active sidebar palette)
- Кнопка «×»: иконка `X` из Lucide, `h-3 w-3`, hover: `text-blue-900`
- Контейнер чипов: `flex flex-wrap gap-2 mb-2`

> **Примечание**: Используется паттерн «Select + chips» вместо отдельного компонента MultiSelect, т.к. shadcn/ui не имеет встроенного MultiSelect. Select фильтрует уже выбранные элементы из списка.

---

## J4. Таблица полей: обновление строки #1

### ИЗМЕНИТЬ: строку #1 в таблице полей вкладки Marketing

**Было (v1.1):**

| #   | Label                | Контрол | Default | Подсказка                                            | Валидация                         |
| --- | -------------------- | ------- | ------- | ---------------------------------------------------- | --------------------------------- |
| 1   | Робот для маркетинга | Select  | —       | «Какой робот используется для маркетингового круиза» | Список зарегистрированных роботов |

**Стало (v1.7):**

| #   | Label                 | Контрол             | Default | Подсказка                                                                      | Валидация                                               |
| --- | --------------------- | ------------------- | ------- | ------------------------------------------------------------------------------ | ------------------------------------------------------- |
| 1   | Роботы для маркетинга | Multi-Select (чипы) | —       | «Какие роботы используются для маркетингового круиза. Можно выбрать несколько» | Список зарегистрированных роботов; дубликаты невозможны |

---

## J5. Toast: информирование при пустом списке

### ДОБАВИТЬ: info-toast при удалении последнего чипа (необязательно, nice-to-have)

При удалении **последнего** робота из чипов (список стал пустым):

```tsx
// Если robot_ids стал пустым — мягкое напоминание
if (newIds.length === 0) {
  toast({
    description: "Не выбран ни один робот для маркетинга. Круиз не будет запускаться",
    duration: 3000,
  });
}
```

| #   | Текст                                                                | Стиль   | Триггер                         |
| --- | -------------------------------------------------------------------- | ------- | ------------------------------- |
| 16  | «Не выбран ни один робот для маркетинга. Круиз не будет запускаться» | default | Удаление последнего чипа робота |

> **Примечание**: Toast #16. Нумерация продолжает реестр из v1.5 (#12–15).

---

## Обновление итогового чеклиста

В дополнение к чеклисту v1.6, добавить:

- [ ] J1: TypeScript интерфейс `marketing.robot_ids: string[]` вместо `robot_id: string`
- [ ] J2: Mock-данные `robot_ids: ["PD2024060001"]`
- [ ] J3: Multi-Select с чипами (Badge) вместо Single Select
- [ ] J3: Клик чипа «×» — удаление робота из списка
- [ ] J3: Дропдаун фильтрует уже выбранных роботов
- [ ] J3: Placeholder обновляется: «Выберите...» / «Добавить ещё...»
- [ ] J3: «Все роботы добавлены» при выборе всех
- [ ] J4: Label «Роботы для маркетинга» (множественное число)
- [ ] J4: Tooltip обновлён: «Можно выбрать несколько»
- [ ] J5: Toast #16 при удалении последнего робота (nice-to-have)

---

## История изменений

| Версия | Дата       | Автор        | Описание                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| ------ | ---------- | ------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.7    | 2026-02-17 | Кирилл Тюрин | J1–J5: Маркетинг Multi-Select роботов. Поле «Робот для маркетинга» (UiSelect, один) заменено на «Роботы для маркетинга» (Multi-Select с чипами, несколько). TypeScript: `robot_id: string` → `robot_ids: string[]`. Mock: `["PD2024060001"]`. UI: Select + Badge-чипы с «×», фильтрация выбранных из дропдауна. Toast #16 при удалении последнего робота. Обоснование: встреча 11.02 — Кирилл (*«два робота только маркетингом»*), Рустам NE (*«Да, будем выбирать»*, рестораны с 15 роботами). Источник: SPEC-002 v1.14. |
