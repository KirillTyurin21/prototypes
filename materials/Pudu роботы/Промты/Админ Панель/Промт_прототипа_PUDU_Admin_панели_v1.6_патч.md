# Промт-патч v1.6: Панель администрирования роботов PUDU в iikoWeb

---
**Версия**: 1.6
**Дата**: 2026-02-17
**Автор**: Кирилл Тюрин (системный аналитик)
**Статус**: [PENDING]
**Артефакт**: Д3-патч (Промт-патч для обновления прототипа iikoWeb)
**Базовый документ**: Промт_прототипа_PUDU_Admin_панели_v1.5_патч.md (v1.5, 2026-02-17)
**Источники**: SPEC-002 v1.13 (раздел 7.4); SPEC-003 v1.9 (разделы 5.1–5.7); Решение Кирилла (17.02.2026)
**Scope**: Рефакторинг вкладки «Уборка посуды» (Э4): показ всех релевантных полей во всех режимах, переименование секций, удаление подсказки о наследовании
---

## Назначение

Этот документ — **дельта-патч** к промту v1.5. Он описывает изменения одной категории:

**H1–H6**: Рефакторинг вкладки «Уборка посуды» (cleanup) на экране Э4 (Б3). При переключении между режимами (Ручной / Автоматический / Смешанный) пользователь теперь видит **все поля, релевантные выбранному режиму**. Универсальные поля (фраза, URL видео, время ожидания) сохраняют введённые значения при переключении режимов.

**Проблема (до патча)**: При переключении на «Автоматический» режим секция с фразой и временем ожидания скрывалась, отображалась подсказка *«Фраза и время ожидания наследуются из ручного режима. Для изменения переключитесь в "Смешанный" режим.»*. Это создавало неудобство: для редактирования фразы нужно было переключаться в другой режим.

**Решение**: Фраза, URL видео и время ожидания **используются во всех режимах** (ручном, авто, смешанном). Поэтому эти поля выделены в секцию **«Настройки поведения у стола»** и отображаются **всегда**, независимо от режима. Секция с авто-таймерами отображается только при режимах «Авто» и «Смешанный».

**Инструкция по применению**: сначала примени базовый промт `Промт_прототипа_PUDU_Admin_панели.md` (v1.1), затем патчи v1.2, v1.3, v1.4, v1.5 и затем этот патч v1.6 — последовательно.

**Ключевые изменения v1.6:**
- Секция «Ручной режим» переименована → **«Настройки поведения у стола»** (видна всегда)
- Секция «Автоматический режим» переименована → **«Таймеры автоматической уборки»** (видна при `auto` / `mixed`)
- Удалена подсказка *«Фраза и время ожидания наследуются из ручного режима...»*
- Обновлены описания Radio-опций (убрано упоминание «из настроек ручного режима»)
- Значения полей не сбрасываются при переключении режимов (поведение)
- Добавлен Info-блок «Настройки используются во всех режимах»

---

## Совместимость с предыдущими патчами

| Патч           | Совместимость | Примечание                                            |
| -------------- | ------------- | ----------------------------------------------------- |
| v1.1 (базовый) | Требуется     | Экран Э4 базовый                                      |
| v1.2 (C1–C10)  | Требуется     | RadioGroup 3 режима (C6) — **частично переопределён** |
| v1.3 (E1–E5)   | Требуется     | —                                                     |
| v1.4 (F1–F13)  | Требуется     | Tooltips, Info-блок мультивыбора (F13)                |
| v1.5 (G1–G7)   | Требуется     | Удаление `phrase_later`, Info-блок датчиков (G7)      |

---

## Перечень изменений v1.6

| #      | Изменение                                    | Область | Причина                                                                     |
| ------ | -------------------------------------------- | ------- | --------------------------------------------------------------------------- |
| **H1** | Переименование секции «Ручной режим»         | Э4 (Б3) | Поля используются во всех режимах, название «Ручной» — вводит в заблуждение |
| **H2** | Переименование секции «Автоматический режим» | Э4 (Б3) | Уточнение: секция содержит только таймеры                                   |
| **H3** | Обновление таблицы условной видимости        | Э4 (Б3) | Авто-режим теперь показывает обе секции                                     |
| **H4** | Обновление описаний Radio-опций              | Э4 (Б3) | Убрано «из настроек ручного режима» — поля видны напрямую                   |
| **H5** | Удаление подсказки о наследовании            | Э4 (Б3) | Больше не нужна — все поля видны                                            |
| **H6** | Info-блок + поведение сохранения значений    | Э4 (Б3) | Значения полей не сбрасываются при переключении режимов                     |

---

## H1. Переименование секции «Ручной режим» → «Настройки поведения у стола»

### Экран Э4 (Б3), файл `components/settings/tab-cleanup.tsx`

### ИЗМЕНИТЬ заголовок секции:

**Было (v1.2 C6):**
- Заголовок H3: **«Ручной режим»**
- Содержит поля: фраза при подъезде, URL видео, время ожидания

**Стало (v1.6):**
- Заголовок H3: **«Настройки поведения у стола»**
- Подзаголовок `text-xs text-gray-500 mt-1`: **«Фраза, видео и время ожидания — используются во всех режимах уборки»**
- Содержит те же поля (после v1.5 G6 — 3 строки: фраза, URL, время ожидания)

**Стилизация заголовка:**
```tsx
<h3 className="text-base font-semibold text-gray-900">
  Настройки поведения у стола
</h3>
<p className="text-xs text-gray-500 mt-1">
  Фраза, видео и время ожидания — используются во всех режимах уборки
</p>
```

**Причина**: Эти поля описывают, как робот ведёт себя у стола (фраза подъезда, видео, время ожидания). Они используются и в ручном, и в автоматическом, и в смешанном режиме. Название «Ручной режим» вводило в заблуждение — казалось, что поля относятся только к ручному запуску.

> **Данные API (без изменений)**: Поля по-прежнему хранятся в `cleanup.manual.*` в БД. Переименование — только на уровне UI.

---

## H2. Переименование секции «Автоматический режим» → «Таймеры автоматической уборки»

### ИЗМЕНИТЬ заголовок секции:

**Было (v1.1 base / v1.2 C6):**
- Заголовок H3: **«Автоматический режим»**

**Стало (v1.6):**
- Заголовок H3: **«Таймеры автоматической уборки»**

```tsx
<h3 className="text-base font-semibold text-gray-900">
  Таймеры автоматической уборки
</h3>
```

**Содержимое секции** — без изменений (после v1.2 C6):

| #   | Label                             | Контрол        | Default | Подсказка                                                                     | Валидация    |
| --- | --------------------------------- | -------------- | ------- | ----------------------------------------------------------------------------- | ------------ |
| 4   | Таймер после доставки блюда (мин) | Input (number) | **12**  | «Через сколько минут после доставки блюда робот приедет для уборки»           | > 0, минуты  |
| 5   | Таймер после закрытия чека (мин)  | Input (number) | —       | «Через сколько минут после закрытия чека робот приедет для уборки. 0 — сразу» | >= 0, минуты |

Под полем 4: подсказка *курсивом* `italic text-xs text-gray-400`: **«Рекомендуемое: 12–14 мин»**

> **Нумерация полей** (после v1.5 G6): Секция «Настройки поведения у стола» содержит поля 1–3, секция «Таймеры» — поля 4–5. Общая нумерация сквозная.

---

## H3. Обновление таблицы условной видимости секций

### ИЗМЕНИТЬ таблицу из v1.2 C6 (обновлённую в v1.5 G6):

**Было (v1.5 G6):**

| Режим          | Секция «Ручной» (фраза, время ожидания) | Секция «Авто» (таймеры) |
| -------------- | --------------------------------------- | ----------------------- |
| Ручной         | Видна                                   | Скрыта                  |
| Автоматический | Скрыта, но **наследуется** (подсказка)  | Видна                   |
| Смешанный      | Видна                                   | Видна                   |

**Стало (v1.6):**

| Режим          | Секция «Настройки поведения у стола» | Секция «Таймеры автоматической уборки» |
| -------------- | ------------------------------------ | -------------------------------------- |
| Ручной         | **Видна**                            | Скрыта                                 |
| Автоматический | **Видна**                            | **Видна** (`animate-fade-in`)          |
| Смешанный      | **Видна**                            | **Видна** (`animate-fade-in`)          |

**Ключевое отличие от v1.5**: При выборе «Автоматический» секция «Настройки поведения у стола» теперь **видна** (не скрыта). Пользователь видит все поля, которые робот использует в авто-режиме.

**Поведение при переключении**: Секция «Таймеры» появляется/исчезает с анимацией `animate-fade-in`. Секция «Настройки поведения» видна **всегда** — не анимируется при переключении.

---

## H4. Обновление описаний Radio-опций

### ИЗМЕНИТЬ описания в Radio Group (определены в v1.2 C6):

**Было (v1.2):**

```
┌──────────────────────────────────────────────────────────────────┐
│ ● Ручной режим                                                   │
│   «Официант вручную отправляет робота для уборки конкретного     │
│   стола через iikoFront»                                         │
├──────────────────────────────────────────────────────────────────┤
│ ○ Автоматический режим                                           │
│   «Робот автоматически отправляется на уборку по таймерам:       │
│   после доставки блюда или закрытия чека»                        │
├──────────────────────────────────────────────────────────────────┤
│ ○ Смешанный режим                                                │
│   «Автоматическая уборка по таймерам с возможностью ручного      │
│   запуска через iikoFront»                                       │
└──────────────────────────────────────────────────────────────────┘
```

**Стало (v1.6):**

```
┌──────────────────────────────────────────────────────────────────┐
│ ● Ручной режим                                                   │
│   «Официант вручную отправляет робота для уборки конкретного     │
│   стола через iikoFront»                                         │
├──────────────────────────────────────────────────────────────────┤
│ ○ Автоматический режим                                           │
│   «Робот автоматически приезжает для уборки по таймерам: после   │
│   доставки блюда или закрытия чека. Кнопка «Уборка» в iikoFront  │
│   скрыта»                                                        │
├──────────────────────────────────────────────────────────────────┤
│ ○ Смешанный режим                                                │
│   «Ручной запуск уборки через iikoFront всегда доступен,         │
│   авто-триггеры (таймеры) работают параллельно в фоне.           │
│   Дублирование задач на один стол исключается автоматически»     │
└──────────────────────────────────────────────────────────────────┘
```

**Что изменилось:**
1. **Авто**: добавлено «Кнопка «Уборка» в iikoFront скрыта» — ключевое отличие авто от смешанного. Убрано упоминание «из настроек ручного режима» (поля видны напрямую)
2. **Смешанный**: расширено описание — «ручной запуск всегда доступен, авто-триггеры параллельно, дедупликация автоматическая». Описание даёт понятное объяснение поведения

**Tooltips (определены в v1.4 F4)** — обновить:

| Элемент                  | `title`                                                                       |
| ------------------------ | ----------------------------------------------------------------------------- |
| Radio «Ручной» (cleanup) | «Уборка запускается вручную из iikoFront» *(без изменений)*                   |
| Radio «Авто» (cleanup)   | «Уборка по таймеру. Кнопка «Уборка» в iikoFront скрыта»                       |
| Radio «Смешанный»        | «Ручной запуск + авто-таймеры параллельно. Дедупликация задач автоматическая» |

---

## H5. Удаление подсказки о наследовании

### УДАЛИТЬ из вкладки cleanup (Э4):

**Удалить подсказку** (определена в v1.2 C6) — текст `text-xs text-orange-500 italic`:

> ~~«Фраза и время ожидания наследуются из ручного режима. Для изменения переключитесь в "Смешанный" режим.»~~

**Причина**: Подсказка была нужна, когда при авто-режиме поля фразы скрывались. Теперь поля видны во всех режимах — подсказка не нужна.

### УДАЛИТЬ Info-блок наследования (определён в SPEC-002, раздел 7.4):

Удалить Info-блок (`border-blue-200 bg-blue-50/50`):

> ~~«Фраза и время ожидания используются из настроек ручного режима»~~

**Причина**: Та же — поля видны напрямую, объяснение наследования излишне.

---

## H6. Info-блок «общие настройки» + поведение сохранения значений

### ДОБАВИТЬ Info-блок в секцию «Настройки поведения у стола»:

Расположение: **после** заголовка + подзаголовка секции, **перед** полем 1 (Фраза при подъезде):

```tsx
<div className="flex items-start gap-3 rounded-lg border border-gray-200 bg-gray-50 p-3 text-xs text-gray-600"
     role="status">
  <Info className="h-4 w-4 text-gray-400 mt-0.5 flex-shrink-0" />
  <span>
    Эти настройки применяются ко всем режимам уборки. Значения сохраняются
    при переключении между режимами.
  </span>
</div>
```

**Стилизация**: Нейтральный стиль (`border-gray-200 bg-gray-50`) — не акцентный, т.к. это справочная информация, а не предупреждение.

### ПОВЕДЕНИЕ: сохранение значений при переключении режимов

**Реализация в `tab-cleanup.tsx`**: При переключении Radio Group (`cleanup.mode`) — **НЕ сбрасывать** значения полей. Состояние формы хранится в едином объекте `cleanupSettings`, переключение `mode` меняет только одно поле — `mode`.

```tsx
// Правильно: переключение меняет только mode
const handleModeChange = (newMode: "manual" | "auto" | "mixed") => {
  setCleanupSettings(prev => ({ ...prev, mode: newMode }));
};

// НЕПРАВИЛЬНО: не сбрасывать поля при переключении!
// setCleanupSettings(prev => ({ ...prev, mode: newMode, phrase_arrival: "" }));
```

**Результат**: Если пользователь ввёл фразу в ручном режиме, затем переключился на автоматический — фраза остаётся в поле. Это соответствует модели данных API, где `cleanup.manual.*` и `cleanup.auto.*` — независимые подобъекты, существующие одновременно.

---

## Итоговая структура вкладки «Уборка посуды» после v1.6

```
┌─────────────────────────────────────────────────────────────────┐
│ Вкладка: Уборка посуды                                          │
│                                                                  │
│ ┌─ Radio Group ─────────────────────────────────────────────┐   │
│ │ ● Ручной режим                                             │   │
│ │   «Официант вручную отправляет робота...»                  │   │
│ │ ○ Автоматический режим                                     │   │
│ │   «Робот по таймерам... Кнопка скрыта»                     │   │
│ │ ○ Смешанный режим                                          │   │
│ │   «Ручной + авто параллельно. Дедупликация авто»           │   │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                  │
│ ┌─ Info: мультивыбор (v1.4 F13) ────────────────────────────┐   │
│ │ (i) Плагин поддерживает мультивыбор столов для уборки...   │   │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                  │
│ ┌─ H3: Настройки поведения у стола ── ВСЕГДА ВИДНА ─────────┐   │
│ │ text-xs: «Фраза, видео и время ожидания — во всех режимах» │   │
│ │                                                             │   │
│ │ ┌─ Info: общие настройки (v1.6 H6) ───────────────────┐   │   │
│ │ │ (i) Эти настройки применяются ко всем режимам.       │   │   │
│ │ │     Значения сохраняются при переключении.            │   │   │
│ │ └──────────────────────────────────────────────────────┘   │   │
│ │                                                             │   │
│ │ [1] Фраза при подъезде к столу ___________  (N/180)        │   │
│ │ [2] URL видео/аудио           ___________                  │   │
│ │ [3] Время ожидания у стола    [90] сек                     │   │
│ │                                                             │   │
│ │ ┌─ Info: ограничение датчиков (v1.5 G7) ──────────────┐   │   │
│ │ │ (i) Робот стоит у стола заданное время и уезжает     │   │   │
│ │ │     безусловно. Определение факта загрузки посуды     │   │   │
│ │ │     недоступно (ограничение API PUDU).                │   │   │
│ │ └──────────────────────────────────────────────────────┘   │   │
│ └─────────────────────────────────────────────────────────────┘   │
│               ↓ только при auto / mixed (animate-fade-in)        │
│ ┌─ H3: Таймеры автоматической уборки ───────────────────────┐   │
│ │ [4] Таймер после доставки блюда  [12] мин                  │   │
│ │     italic: «Рекомендуемое: 12–14 мин»                     │   │
│ │ [5] Таймер после закрытия чека   [__] мин                  │   │
│ └────────────────────────────────────────────────────────────┘   │
│                                                                  │
│ [ Сохранить ]                                                    │
└─────────────────────────────────────────────────────────────────┘
```

---

## Обновление итогового чеклиста

В дополнение к чеклисту v1.5, добавить:

- [ ] H1: Секция «Ручной режим» переименована → «Настройки поведения у стола» (H3 + подзаголовок)
- [ ] H2: Секция «Автоматический режим» переименована → «Таймеры автоматической уборки»
- [ ] H3: При режиме «Автоматический» — видны обе секции (настройки + таймеры)
- [ ] H3: При режиме «Ручной» — видна только секция «Настройки поведения у стола»
- [ ] H3: При режиме «Смешанный» — видны обе секции
- [ ] H4: Описание Radio «Авто» содержит «Кнопка «Уборка» в iikoFront скрыта»
- [ ] H4: Описание Radio «Смешанный» содержит «дедупликация»
- [ ] H4: Tooltips Radio обновлены
- [ ] H5: Подсказка `text-orange-500` о наследовании — УДАЛЕНА
- [ ] H5: Info-блок «из настроек ручного режима» — УДАЛЁН
- [ ] H6: Info-блок «настройки во всех режимах» — ДОБАВЛЕН (border-gray-200 bg-gray-50)
- [ ] H6: При переключении режима — значения полей НЕ сбрасываются
- [ ] Confirm 24ч при смене фразы — по-прежнему работает (наследуется из v1.4 F5)
- [ ] Info-блок мультивыбора (v1.4 F13) — по-прежнему на месте
- [ ] Info-блок ограничения датчиков (v1.5 G7) — по-прежнему на месте

---

## История изменений

| Версия | Дата       | Автор        | Описание                                                                                                                                                                                                                                                                                                                                                    |
| ------ | ---------- | ------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 1.6    | 2026-02-17 | Кирилл Тюрин | H1–H6: Рефакторинг вкладки cleanup — все релевантные поля видны во всех режимах. Секция «Ручной режим» → «Настройки поведения у стола» (видна всегда). Секция «Автоматический режим» → «Таймеры автоматической уборки» (авто/смешанный). Удалена подсказка о наследовании. Обновлены описания Radio-опций. Значения полей не сбрасываются при переключении. |
