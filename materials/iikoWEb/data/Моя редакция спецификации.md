# Спецификация Sprint 3: Контролы подсказок и Область подсказок в Теме

> **Версия:** 2.0  
> **Дата:** 11.02.2026  
> **Автор:** Михаил (аналитик)  
> **Статус:** Готово к разработке  
> **Основание:** ФТ «Подсказки» v0.9, итоги встреч 05.02 и 09.02.2026

---

## 1. Scope спринта

### 1.1 Сводная таблица задач

| # | Задача | Тип | Приоритет | Зависимости |
|:--|:-------|:----|:----------|:------------|
| S3-001 | Типизация контролов в БД | Backend | P0 | Нет — стартует первой |
| S3-002 | Контрол подсказки (frontend) | Frontend | P0 | S3-001 |
| S3-003 | Область подсказок в Теме (frontend) | Frontend | P0 | S3-002; KT Ваня → Вадим |
| S3-003b | Динамическая область (опционально) | Frontend | P2 | S3-003 завершена |
| S3-004 | Подготовительная работа по плагину (spike) | Spike | P1 | Независимая |
| S3-005 | Колонка «Подсказки» в настройках терминалов | Frontend | P2 | Backend готов |

### 1.2 Бизнес-правила Sprint 3

| # | Правило |
|:--|:--------|
| БП-1 | Блюдо уже в чеке → подсказку не показывать (реализация в плагине — Sprint 4+) |
| БП-2 | Тип контрола нельзя изменить после создания — только удалить и создать заново |
| БП-3 | В MVP — только режим «Лист» для области подсказок |
| БП-4 | Порядок колонок в терминалах: Тема → Рекл. кампания → Подсказка |
| БП-5 | Z-index: подсказки отображаются поверх рекламы (Advertise), когда подсказка активна |
| БП-6 | Единый справочник контролов с типизацией полем `type`, а не два раздельных справочника |
| БП-7 | Изображение (баннер) — обязательный элемент контрола подсказки. При отсутствии картинки отображается заглушка (аналогично анимациям) |
| БП-8 | Плагин помещает в стэк очередей только позиции чека с привязанной подсказкой (Sprint 4+) |
| БП-9 | Область подсказок прозрачна для покупателя на дисплее, но видима для дизайнера в конструкторе Тем (пунктирная рамка) |
| БП-10 | Фиксированные позиции элементов, без автоматического растягивания. Если не умещается — дизайнер подгоняет размеры вручную |

---

## 2. Что НЕ входит в Sprint 3

| # | Функционал | Когда |
|:--|:-----------|:------|
| И-1 | Готовый плагин (отрисовка подсказок на дисплее) | Sprint 4+ |
| И-2 | Новые типы анимаций (появление / исчезновение элементов) | MVP+ |
| И-3 | Анимация показа подсказки (визуальные эффекты при появлении). Настройки «Длительность анимации» и «Тип анимации» в S3-003 — заготовка UI, функционально не активны до Sprint 4+ | v2 |
| И-4 | Динамически заполняемая область (S3-003b — если не успеют) | Sprint 3 P2 или Sprint 4 |
| И-5 | Информационная подсказка (без привязки к триггеру) | v2 |
| И-6 | Подсказка кассиру на iikoFront | v2 |
| И-7а | Ветвистость подсказок (цепочки: подсказка → подсказка → подсказка) | v2+ |
| И-7б | Ограничение глубины ветвистости (валидация макс. уровня вложенности) | v2+ |
| И-8 | Папки подсказок | v2 |
| И-9 | Процентная / суммовая скидка (ручной ввод суммы) | Не планируется |
| И-10 | Изображение блюда-триггера (уже добавленного в чек) в подсказке | Не планируется |

---

## 3. Задача S3-001: Типизация контролов в БД (backend)

| Параметр | Значение |
|:---------|:---------|
| Приоритет | P0 — стартует первой |
| Исполнитель | Рома (backend) |

### Что сделать

Добавить поле `type` в сущность контрола в БД для разделения контролов на два типа:

| Значение типа | Описание |
|:--------------|:---------|
| `IMAGE` | Контрол анимации (существующий функционал) |
| `HINT` | Контрол подсказки (новый функционал) |

### Требования

1. Все существующие контролы получают тип `IMAGE` (миграция данных)
2. Тип обязателен при создании контрола
3. Тип неизменяем после создания (БП-2)
4. Набор доступных элементов контрола зависит от его типа

### Критерии приёмки

- [ ] Поле `type` добавлено в модель контрола
- [ ] Существующие контролы мигрированы с типом `IMAGE`
- [ ] При создании контрола тип обязателен
- [ ] Тип нельзя изменить после создания (ответ с ошибкой при попытке)
- [ ] Обратная совместимость: существующие контролы анимации работают без изменений

---

## 4. Задача S3-002: Контрол подсказки (frontend)

| Параметр | Значение |
|:---------|:---------|
| Приоритет | P0 |
| Исполнитель | Ваня (frontend) |
| Зависимость | S3-001 |

### Что сделать

1. Реализовать выбор типа контрола при создании — выпадающий список «Тип контрола»
2. Реализовать Drawer-карточку контрола подсказки — форма настройки с **16 элементами** (10 переиспользуемых + 6 уникальных)
3. Пользователь сам выбирает какие элементы включить через «Добавить элемент». **Баннер подсказки** добавляется автоматически и не может быть удалён (БП-7)
4. Заблокировать смену типа после первого сохранения — бейдж «Подсказка» read-only
5. Отображать предпросмотр контрола подсказки в preview-области конструктора
6. Обратная совместимость — редактирование существующих контролов анимации не ломается

### 4.1 Параметры контрола (боковая панель редактирования)

#### Имя контрола

Текстовое поле для ввода наименования контрола.

#### Тип контрола

Выпадающий список (Select) с двумя вариантами:

| Значение | Иконка | Отображаемое название | Описание |
|:---------|:-------|:----------------------|:---------|
| `IMAGE` | Иконка анимации | Контрол анимации | Визуальное оформление для отображения информации о добавленном блюде |
| `HINT` | Иконка подсказки | Контрол подсказки | Визуальное оформление для отображения информации о скидке и рекомендации |

**Поведение:**

1. При создании нового контрола — выбрать тип из выпадающего списка
2. При выборе типа `HINT` — открывается форма контрола подсказки с доступным набором элементов (см. 4.2)
3. После первого сохранения — поле «Тип контрола» становится read-only (отображается как бейдж)

---

### 4.2 Элементы контрола подсказки (16 элементов)

Элементы добавляются через боковую панель «Добавить элемент», которая открывается поверх основной панели настроек. Все элементы опциональны, кроме «Баннер подсказки» (добавлен автоматически).

#### Переиспользуемые из Анимаций (10 элементов)

| # | Элемент | Идентификатор типа | Тип данных | Источник данных | Атрибуты |
|:--|:--------|:-------------------|:-----------|:----------------|:---------|
| 1 | Область (контейнер) | `area` | Контейнер | Конструктор | Макет, Граница |
| 2 | Текст | `text` | Текст (ручной ввод) | Произвольный ввод администратором | Макет, Граница, Шрифт |
| 3 | Изображение (статическое) | `image` | Картинка (PNG/JPG) | Загрузка / галерея | Макет, Граница |
| 4 | Изображение товара | `productImage` | Картинка | Внешнее меню / галерея | Макет, Граница |
| 5 | Название продукта | `productName` | Текст | Номенклатура iiko | Макет, Граница, Шрифт |
| 6 | Полное название продукта | `productFullName` | Текст | Номенклатура iiko | Макет, Граница, Шрифт |
| 7 | Иностранное название продукта | `productForeignName` | Текст | Номенклатура iiko | Макет, Граница, Шрифт |
| 8 | Цена | `price` | Форматированная сумма | Номенклатура iiko | Макет, Граница, Шрифт |
| 9 | Описание продукта | `productDescription` | Текст | Номенклатура iiko | Макет, Граница, Шрифт |
| 10 | Описание товара (за рубежом) | `productForeignDescription` | Текст | Номенклатура iiko | Макет, Граница, Шрифт |

#### Уникальные для Подсказок (6 элементов)

| # | Элемент | Идентификатор типа | Тип данных | Источник данных | Атрибуты |
|:--|:--------|:-------------------|:-----------|:----------------|:---------|
| 11 | Слоган | `hintSlogan` | Текст (до 250 символов) | Справочник подсказок → поле «Слоган» | Макет, Граница, Шрифт |
| 12 | Баннер подсказки | `hintBanner` | Картинка (PNG/JPG) | Карточка подсказки → загрузка; заглушка при отсутствии | Макет, Граница |
| 13 | Название скидки | `discountName` | Текст | Справочник скидок iiko | Макет, Граница, Шрифт |
| 14 | Размер скидки | `discountAmount` | Форматированная сумма с валютой | Справочник скидок iiko (% или сумма) | Макет, Граница, Шрифт |
| 15 | Старая цена | `oldPrice` | Форматированная сумма с валютой | Номенклатура iiko → цена (стиль по умолч. — зачёркнутый) | Макет, Граница, Шрифт |
| 16 | Цена со скидкой | `discountedPrice` | Форматированная сумма с валютой | Вычисляемое: Цена − Скидка | Макет, Граница, Шрифт |

---

### 4.3 Атрибуты элементов

Каждый элемент контрола имеет до 3 секций настроек в зависимости от типа элемента (указаны в колонке «Атрибуты» таблиц выше).

#### Секция «Макет» (Layout)

| Параметр | Тип | По умолч. | Описание |
|:---------|:----|:----------|:---------|
| Цвет фона | Color picker | `#ffffff` | Фоновый цвет элемента |
| Прозрачность фона | Number (%) | 100 | 0 — полностью прозрачный, 100 — непрозрачный |
| Отступ сверху | Number (px) | 0 | Позиция по вертикали |
| Отступ слева | Number (px) | 0 | Позиция по горизонтали |
| Ширина | Number (px) | — | Ширина элемента |
| Высота | Number (px) | — | Высота элемента |
| Слой (Z-index) | Number | auto | Порядок наложения элементов |
| Угол поворота | Number (°) | 0 | Поворот элемента |

#### Секция «Граница» (Border)

| Параметр | Тип | По умолч. | Описание |
|:---------|:----|:----------|:---------|
| Ширина границы | Number (px) | 0 | Толщина рамки |
| Цвет границы | Color picker | `#ffffff` | Цвет рамки |
| Тип границы | Select | none | Варианты: none / solid / dashed / dotted |
| Скругление углов | Number (px) | 0 | Радиус скругления |

#### Секция «Шрифт» (Font) — только для текстовых элементов

| Параметр | Тип | По умолч. | Описание |
|:---------|:----|:----------|:---------|
| Цвет шрифта | Color picker | `#000000` | Цвет текста |
| Размер шрифта | Number (px) | 14 | Размер шрифта |
| Семейство шрифта | Select | — | Выбор гарнитуры |
| Выравнивание текста | Select | left | Варианты: left / center / right |
| Стиль шрифта | Select | normal | Варианты: normal / italic |
| Начертание шрифта | Select | normal | Варианты: normal / bold |

---

### 4.4 Критерии приёмки S3-002

- [ ] Выпадающий список «Тип контрола» отображается с вариантами «Контрол анимации» и «Контрол подсказки»
- [ ] При выборе типа `HINT` доступен набор из 16 элементов (10 переиспользуемых + 6 уникальных)
- [ ] Элемент «Баннер подсказки» добавлен автоматически и не удаляется
- [ ] При отсутствии загруженной картинки в баннере — отображается заглушка
- [ ] Тип контрола заблокирован после первого сохранения (бейдж read-only)
- [ ] Все 3 секции атрибутов («Макет», «Граница», «Шрифт») работают для соответствующих элементов
- [ ] Предпросмотр контрола подсказки отображается в preview-области конструктора
- [ ] Редактирование существующих контролов анимации работает без изменений — **регресса нет**

---

## 5. Задача S3-003: Область подсказок в Теме (frontend)

| Параметр | Значение |
|:---------|:---------|
| Приоритет | P0 |
| Исполнитель | Вадим (frontend) |
| Зависимость | S3-002 (для тестирования); KT Ваня → Вадим (обязательно до начала) |

### Что сделать

Реализовать элемент **«Область подсказок»** в конструкторе Тем Customer Screen. Область — контейнер для контролов подсказок, портированный из архитектуры Arrivals. В Sprint 3 — **только режим «Лист»**.

**Путь:** iikoWeb → Дисплей покупателя → Темы → [Тема] → Редактирование темы

### 5.1 Добавление элемента «Область подсказок» в Тему

Кнопка **«Добавить элемент»** → выпадающий список:

| Пункт меню | Статус |
|:-----------|:-------|
| Изображение | Существующий |
| Текст | Существующий |
| Рекламный блок | Существующий |
| Анимации | Существующий |
| **Область подсказок** | **Новый** |

При выборе «Область подсказок» — на канвасе создаётся блок Области, справа открывается панель настроек.

### 5.2 Настройки элемента «Область подсказок» (правая панель)

#### Секция «Область подсказок» (уникальные настройки)

| # | Настройка | Тип контрола | Значение по умолч. | Валидация | Описание |
|:--|:----------|:-------------|:-------------------|:----------|:---------|
| 1 | Режим области | Select (disabled) | Лист | — | Заблокирован в Sprint 3. Единственный вариант — «Лист» |
| 2 | Направление заполнения | Select | Горизонтально (→) | — | Варианты: Горизонтально (→) / Вертикально (↓) |
| 3 | Макс. кол-во столбцов | Number | 1 | Min: 1 | Определяет сколько контролов в ряд |
| 4 | Межстрочный интервал | Number (px) | 8 | Min: 0 | Отступ между строками контролов |
| 5 | Межстолбцовый интервал | Number (px) | 8 | Min: 0 | Отступ между столбцами контролов |
| 6 | Время жизни подсказки | Number (сек) | 30 | Min: 1, Max: 999 | Подсказка автоматически исчезает по истечении этого времени |
| 7 | Макс. кол-во подсказок одновременно | Number | 3 | Min: 1, Max: 10 | Максимальное количество одновременно видимых подсказок |

#### Секция «Макет» (стандартная)

| Параметр | Тип | Описание |
|:---------|:----|:---------|
| Позиция X | Number (px) | Горизонтальная позиция области на канвасе |
| Позиция Y | Number (px) | Вертикальная позиция области на канвасе |
| Ширина | Number (px) | Ширина области |
| Высота | Number (px) | Высота области |
| Отступы (padding) | Number (px) × 4 | Внутренние отступы (сверху, справа, снизу, слева) |

#### Секция «Граница» (стандартная)

| Параметр | Тип | Описание |
|:---------|:----|:---------|
| Толщина рамки | Number (px) | Толщина границы области |
| Цвет рамки | Color picker | Цвет границы |
| Скругление | Number (px) | Радиус скругления углов |
| Тень | Toggle + параметры | Включение и настройка тени |

### 5.3 Прозрачность области

| Контекст | Поведение |
|:---------|:---------|
| Конструктор Тем | Область **видима** — пунктирная рамка / подсветка границ для дизайнера |
| Дисплей покупателя | Область **прозрачна** (background: transparent). Покупатель видит только содержимое (подсказки), не контейнер |

### 5.4 Настройки из Arrivals, которые НЕ переносятся

| # | Настройка Arrivals | Причина исключения |
|:--|:-------------------|:-------------------|
| 1 | Расположение контролов (готовые выше/ниже) | Специфично для статусов заказов |
| 2 | Тип статуса заказа | Не применимо к подсказкам |
| 3 | Статус заказа | Не применимо |
| 4 | Источники заказа | Не применимо |
| 5 | Типы заказов | Не применимо |
| 6 | Сортировка заказов | Специфично для Arrivals |
| 7 | Построчное чередование | Не релевантно для баннеров |
| 8 | Количество строк | Автоматически определяется границами области |

### 5.5 Критерии приёмки S3-003

- [ ] Пункт «Область подсказок» доступен в выпадающем списке «Добавить элемент» при редактировании Темы
- [ ] При добавлении — блок области отображается на канвасе с пунктирной рамкой
- [ ] Все 7 уникальных настроек области работают (режим, направление, столбцы, интервалы, время жизни, макс. количество)
- [ ] Режим области заблокирован на значении «Лист» (Select disabled)
- [ ] Секции «Макет» и «Граница» работают
- [ ] Направление заполнения переключается между горизонтальным и вертикальным
- [ ] Настройки сохраняются и восстанавливаются при повторном открытии Темы
- [ ] Существующие элементы Темы (Изображение, Текст, Рекламный блок, Анимации) работают без изменений — **регресса нет**

---

## 6. Задача S3-003b: Динамическая область (опционально)

| Параметр | Значение |
|:---------|:---------|
| Приоритет | P2 — опционально |
| Исполнитель | Вадим (frontend) |

### Что сделать

Разблокировать Select «Режим области» — добавить значение **«Динамически заполняемая область»**. Область автоматически растёт / сжимается в зависимости от количества активных контролов.

### Условие включения в Sprint 3

Берётся в работу **только** при выполнении **всех** условий:

1. S3-003 (режим «Лист») полностью завершена
2. ≥ 3 рабочих дня до конца спринта
3. Вадим подтверждает готовность

### Критерии приёмки

- [ ] Select «Режим области» разблокирован: «Лист» и «Динамическая»
- [ ] Область автоматически расширяется / сжимается при добавлении / удалении подсказок
- [ ] Переключение режимов не теряет настройки вложенных элементов
- [ ] Режим «Лист» (S3-003) продолжает работать — **регресса нет**

---

## 7. Задача S3-004: Подготовительная работа по плагину (spike)

| Параметр | Значение |
|:---------|:---------|
| Приоритет | P1 |
| Исполнитель | Даша (frontend / plugin) |
| Тип | Spike / Исследование |
| Решение | Spike в Sprint 3, формальная production-приёмка — Sprint 4 |

### Что сделать

Провести **исследование** архитектуры **Area + Control** в плагине Arrivals и подготовить план переноса в плагин Customer Screen. Это **не готовый перенос** — задача на анализ кода и оценку трудоёмкости.

### Scope исследования

| # | Что изучить | Ожидаемый ответ |
|:--|:------------|:----------------|
| 1 | Архитектура Area в Arrivals | Схема классов, ключевые абстракции |
| 2 | Архитектура Control в Arrivals | Интерфейсы, жизненный цикл |
| 3 | Зависимости Area / Control от модулей Arrivals | Что переиспользуется, что переписывается |
| 4 | Механизм кэширования | Аналогия с Advertise |
| 5 | Render pipeline | Layout, direction, gap |
| 6 | Различия CS и Arrivals | Перечень «чего нет» в CS |

### Ожидаемый результат

| # | Артефакт |
|:--|:---------|
| 1 | Документ исследования — архитектура, зависимости, план адаптации |
| 2 | Оценка трудоёмкости полного переноса (для Sprint 4) |
| 3 | (Опционально) Proof-of-concept — static Area + 1 контрол в CS-плагине |

### Критерии приёмки

- [ ] Создан документ исследования: архитектура Area + Control в Arrivals
- [ ] Определён перечень модулей для переноса / переписывания
- [ ] Зафиксирован список зависимостей, отсутствующих в CS
- [ ] Подготовлена оценка трудоёмкости для Sprint 4
- [ ] (Опционально) PoC: статическая Область + 1 контрол в CS-плагине

---

## 8. Задача S3-005: Колонка «Подсказки» в настройках терминалов

| Параметр | Значение |
|:---------|:---------|
| Приоритет | P2 |
| Исполнитель | К уточнению (frontend). Backend **готов** |
| Тип | Frontend |

### Что сделать

Добавить колонку **«Подсказки»** в таблицу настроек терминалов CS. Чекбокс на пересечении подсказки × терминал.

**Путь:** iikoWeb → Дисплей покупателя → Настройки терминалов

### UI: Таблица настроек терминалов

Порядок колонок зафиксирован:

| Колонка | Статус | Порядок |
|:--------|:-------|:--------|
| (существующие) | Без изменений | — |
| Тема | Существующая | N |
| Рекл. кампания | Существующая | N+1 |
| **Подсказки** | **Новая** | N+2 |

**Содержимое колонки:**

- Каждая подсказка из справочника — отдельная строка (название)
- Чекбокс на пересечении подсказки × терминал
- Множественный выбор: N подсказок на 1 терминал
- Назначение **поштучное** (v1). Группы / папки — v2

### Критерии приёмки

- [ ] Колонка «Подсказки» появилась после «Рекл. кампания» (порядок: Тема → Рекл. кампания → Подсказки)
- [ ] Отображаются все подсказки из справочника (каждая — строка)
- [ ] Чекбоксы работают (множественный выбор: N подсказок на 1 терминал)
- [ ] Назначения сохраняются и восстанавливаются при повторном открытии
- [ ] При пустом справочнике — колонка пустая (graceful empty state)
- [ ] Layout существующих колонок не ломается — **регресса нет**

---

## 9. Зависимости между задачами

### Матрица зависимостей

| Зависимость | Блокер → Зависимый | Критичность | Митигация |
|:------------|:--------------------|:------------|:----------|
| S3-001 → S3-002 | Типизация в БД | Высокая | Ваня использует моки до готовности backend |
| S3-002 → S3-003 | Контрол для тестирования области | Средняя | Вадим использует мок-контрол |
| KT Ваня → Вадим → S3-003 | Knowledge Transfer по коду области | Высокая | Запланировать до начала Sprint 3 |
| Backend терминалов → S3-005 | Backend назначения | Нет блокера | Уже готов |

### Рекомендуемый порядок старта

| Неделя 1 | Неделя 2 |
|:---------|:---------|
| Рома: S3-001 (типизация) | Ваня: S3-002 (контрол подсказки) |
| Ваня: KT для Вадима по области | Вадим: S3-003 (область в Теме) |
| Даша: S3-004 (spike плагина) | Даша: S3-004 (продолжение) |
| | К уточн.: S3-005 (терминалы) |

---

## 10. Открытые вопросы

| # | Вопрос | Кому адресован | Статус |
|:--|:-------|:---------------|:-------|
| ОВ-1 | Выравнивание: считается ли 4-м атрибутом или частью секции «Шрифт»? | PM / Ваня | Открыт |
| ОВ-2 | Исполнитель S3-005 (frontend-часть колонки терминалов) | Михаил | Открыт |
| ОВ-3 | Формат валюты в элементах скидки: руб. / RUB / символ валюты | PM | Открыт |
| ОВ-4 | Preview контрола подсказки — отображать в Drawer или только в конструкторе Тем? | PM / Ваня | Открыт |
| ОВ-5 | Поведение при удалении блюда-триггера из чека: убрать подсказку сразу или оставить до конца заказа? | Руслан (PO) | Открыт |
| ОВ-6 | Циклическая защита (блюдо A → подсказка B, блюдо B → подсказка A): валидация на клиенте или сервере? | Backend | Открыт |

---

## 11. История изменений

| Версия | Дата | Автор | Изменения |
|:-------|:-----|:------|:----------|
| 1.0 | 10.02.2026 | Михаил | Первоначальная сборка на основании ФТ v0.9 и итогов встреч |
| 1.2 | 10.02.2026 | Михаил | GAP-анализ с транскриптом 09.02: 16 элементов, прозрачность области, баннер обязателен |
| 2.0 | 11.02.2026 | Михаил | Финальная редакция: удалены рабочие заметки, добавлены элементы #4 и #10, формализованы атрибуты, добавлена секция S3-001, устранены противоречия, сквозная нумерация |
